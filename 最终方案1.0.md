ä»¥ä¸‹æ˜¯ä¸ºæ‚¨æ•´ç†çš„**æœ¬åœ°åŒ–åŒ»ç–— AI æ¨èç³»ç»Ÿå®Œæ•´é›†æˆæ–¹æ¡ˆ**ã€‚

æœ¬æ–¹æ¡ˆåŸºäºæ‚¨ç°æœ‰çš„ Spring Boot é¡¹ç›®æ¶æ„ï¼Œé€šè¿‡å¼•å…¥ Deeplearning4j (DL4J) å®ç°\*\*â€œè§„åˆ™åŒ¹é… + è¯­ä¹‰å‘é‡â€**çš„åŒå±‚æ¨èå¼•æ“ã€‚ç›¸æ¯”è°ƒç”¨å¤–éƒ¨ APIï¼Œæœ¬æ–¹æ¡ˆå…·æœ‰**é›¶å»¶è¿Ÿã€é›¶è´¹ç”¨ã€æ•°æ®éšç§å®‰å…¨\*\*çš„ä¼˜åŠ¿ã€‚

-----

# ğŸ¥ æœ¬åœ°åŒ–åŒ»ç–— AI æ¨èç³»ç»Ÿé›†æˆæŒ‡å— (v1.0)

## ğŸ“Œ æ–¹æ¡ˆæ¦‚è¿°

  * **æ ¸å¿ƒç›®æ ‡**ï¼šè®©æ¨èç³»ç»Ÿâ€œè¯»æ‡‚â€æ‚£è€…çš„è‡ªç„¶è¯­è¨€æè¿°ï¼ˆå¦‚â€œå¿ƒå£åƒå‹å¤§çŸ³å¤´â€ï¼‰ï¼Œå¹¶å°†å…¶ä¸åŒ»ç”Ÿçš„æ“…é•¿é¢†åŸŸï¼ˆå¦‚â€œå† å¿ƒç—…â€ï¼‰è¿›è¡ŒåŒ¹é…ï¼Œä¸ä»…ä»…ä¾èµ–å…³é”®è¯é‡å ã€‚
  * **æŠ€æœ¯æ ˆ**ï¼šSpring Boot 3 + Deeplearning4j (DL4J) + Word2Vec + Jiebaåˆ†è¯ã€‚
  * **æ€§èƒ½ç­–ç•¥**ï¼šå¯åŠ¨æ—¶é¢„è®¡ç®—åŒ»ç”Ÿç‰¹å¾å‘é‡å¹¶ç¼“å­˜ï¼Œè¿è¡Œæ—¶ä»…éœ€è¿›è¡Œæ¯«ç§’çº§å‘é‡è¿ç®—ã€‚

-----

## ğŸ› ï¸ ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ– (pom.xml)

åœ¨ `dependencies` ä¸­æ·»åŠ  AI æ ¸å¿ƒåº“ã€‚ä¸ºäº†å…¼å®¹ Java 21 å’Œ Windows ç¯å¢ƒï¼Œæˆ‘ä»¬æ˜¾å¼å¼•å…¥äº† OpenBLASã€‚

**æ–‡ä»¶è·¯å¾„**ï¼š`springboot/pom.xml`

```xml
<dependencies>
    <dependency>
        <groupId>org.deeplearning4j</groupId>
        <artifactId>deeplearning4j-nlp</artifactId>
        <version>1.0.0-M2.1</version>
    </dependency>

    <dependency>
        <groupId>org.nd4j</groupId>
        <artifactId>nd4j-native-platform</artifactId>
        <version>1.0.0-M2.1</version>
    </dependency>

    <dependency>
        <groupId>org.bytedeco</groupId>
        <artifactId>openblas-platform</artifactId>
        <version>0.3.21-1.5.8</version>
    </dependency>
</dependencies>
```

-----

## ğŸš€ ç¬¬äºŒæ­¥ï¼šåˆ›å»º AI æ ¸å¿ƒå¼•æ“ (WordVectorService)

**æ–°å¢æ–‡ä»¶**ã€‚è¯¥æœåŠ¡è´Ÿè´£åŠ è½½æ¨¡å‹æ–‡ä»¶ï¼Œæä¾›åº•å±‚çš„â€œæ–‡æœ¬è½¬å‘é‡â€å’Œâ€œç›¸ä¼¼åº¦è®¡ç®—â€èƒ½åŠ›ã€‚

**æ–‡ä»¶è·¯å¾„**ï¼š`springboot/src/main/java/com/example/springboot/service/WordVectorService.java`

```java
package com.example.springboot.service;

import org.deeplearning4j.models.embeddings.loader.WordVectorSerializer;
import org.deeplearning4j.models.word2vec.Word2Vec;
import org.nd4j.linalg.api.ndarray.INDArray;
import org.nd4j.linalg.ops.transforms.Transforms;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import javax.annotation.PostConstruct;
import java.io.File;
import java.util.Collection;
import java.util.Collections;
import java.util.List;

/**
 * AI è¯å‘é‡æœåŠ¡å¼•æ“
 * æ ¸å¿ƒåŠŸèƒ½ï¼šåŠ è½½æœ¬åœ° .bin æ¨¡å‹ï¼Œå°†æ–‡æœ¬è½¬æ¢ä¸ºæ•°å­¦å‘é‡ï¼Œè®¡ç®—è¯­ä¹‰ç›¸ä¼¼åº¦
 */
@Service
public class WordVectorService {

    private static final Logger logger = LoggerFactory.getLogger(WordVectorService.class);
    
    private Word2Vec word2VecModel;

    // æ¨¡å‹è·¯å¾„é…ç½®åœ¨ application.yml
    @Value("${ai.model.path:models/medical_word2vec.bin}")
    private String modelPath;

    @PostConstruct
    public void init() {
        try {
            File modelFile = new File(modelPath);
            if (modelFile.exists()) {
                logger.info("â³ æ­£åœ¨åŠ è½½ AI è¯­ä¹‰æ¨¡å‹: {} (é¢„è®¡è€—æ—¶ 2-5 ç§’)...", modelPath);
                // åŠ è½½ Google Word2Vec æ ¼å¼çš„äºŒè¿›åˆ¶æ¨¡å‹
                this.word2VecModel = WordVectorSerializer.readWord2VecModel(modelFile);
                logger.info("âœ… AI æ¨¡å‹åŠ è½½æˆåŠŸï¼è¯æ±‡é‡: {}", word2VecModel.getVocab().numWords());
            } else {
                logger.warn("âš ï¸ æœªæ‰¾åˆ°æ¨¡å‹æ–‡ä»¶: {}ã€‚ç³»ç»Ÿå°†è‡ªåŠ¨é™çº§ä¸ºã€çº¯å…³é”®è¯åŒ¹é…æ¨¡å¼ã€‘ã€‚", modelPath);
            }
        } catch (Exception e) {
            logger.error("âŒ æ¨¡å‹åŠ è½½å¤±è´¥ (è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–ä¾èµ–ç‰ˆæœ¬)", e);
        }
    }

    /**
     * å°†åˆ†è¯åˆ—è¡¨è½¬æ¢ä¸ºå¥å‘é‡ (Sentence Vector)
     * ç®—æ³•ï¼šå¹³å‡è¯å‘é‡æ³• (Averaging Word Vectors)
     */
    public INDArray encodeText(List<String> words) {
        if (word2VecModel == null || words == null || words.isEmpty()) {
            return null;
        }

        INDArray sumVector = null;
        int count = 0;

        for (String word : words) {
            if (word2VecModel.hasWord(word)) {
                INDArray vector = word2VecModel.getWordVectorMatrix(word);
                if (sumVector == null) {
                    sumVector = vector.dup(); // å¤åˆ¶å‘é‡ï¼Œé˜²æ­¢ä¿®æ”¹æ¨¡å‹å†…éƒ¨æ•°æ®
                } else {
                    sumVector.addi(vector);   // å‘é‡ç´¯åŠ 
                }
                count++;
            }
        }

        // æ±‚å¹³å‡å€¼ï¼Œç”Ÿæˆå½’ä¸€åŒ–çš„å¥å‘é‡
        if (sumVector != null && count > 0) {
            return sumVector.divi(count);
        }
        return null;
    }

    /**
     * è®¡ç®—ä¸¤ä¸ªå‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦ (Cosine Similarity)
     * è¿”å›å€¼: 0.0 (ä¸ç›¸å…³) ~ 1.0 (å®Œå…¨ä¸€è‡´)
     */
    public double calculateSimilarity(INDArray vec1, INDArray vec2) {
        if (vec1 == null || vec2 == null) return 0.0;
        return Transforms.cosineSim(vec1, vec2);
    }

    /**
     * AI è”æƒ³ï¼šæŸ¥æ‰¾æœ€ç›¸ä¼¼çš„ N ä¸ªè¯ (ç”¨äºåŒä¹‰è¯æ‰©å±•)
     */
    public Collection<String> findNearestWords(String word, int topN) {
        if (word2VecModel == null || !word2VecModel.hasWord(word)) {
            return Collections.emptyList();
        }
        return word2VecModel.wordsNearest(word, topN);
    }
    
    // æœåŠ¡å¥åº·æ£€æŸ¥
    public boolean isReady() {
        return word2VecModel != null;
    }
}
```

-----

## ğŸ”„ ç¬¬ä¸‰æ­¥ï¼šå‡çº§ NLP æœåŠ¡ (NLPService)

**ä¿®æ”¹ç°æœ‰æ–‡ä»¶**ã€‚æ³¨å…¥ `WordVectorService`ï¼Œå¼€æ”¾åˆ†è¯æ¥å£ï¼Œå¹¶å‡çº§åŒ¹é…é€»è¾‘ã€‚

**æ–‡ä»¶è·¯å¾„**ï¼š`springboot/src/main/java/com/example/springboot/service/NLPService.java`

```java
// æ·»åŠ å¿…è¦çš„ Import
import org.nd4j.linalg.api.ndarray.INDArray;
import com.example.springboot.util.CosineSimilarityCalculator;

// ... åœ¨ç±»å®šä¹‰å†…éƒ¨ ...

    @Autowired
    private WordVectorService wordVectorService; // <--- ã€æ–°å¢æ³¨å…¥ã€‘

    // -------------------------------------------------------------------------
    // 1. æ–°å¢å…¬å…±åˆ†è¯æ–¹æ³• (ä¾›æ¨èç®—æ³•å±‚è°ƒç”¨)
    // -------------------------------------------------------------------------
    public List<String> segmentText(String text) {
        if (text == null || text.trim().isEmpty()) {
            return new ArrayList<>();
        }
        // å¤ç”¨åŸæœ‰çš„æ–‡æœ¬æ ‡å‡†åŒ–é€»è¾‘
        String normalized = normalizeText(text);
        // å¤ç”¨åŸæœ‰çš„ Jieba åˆ†è¯å™¨
        return segmenter.sentenceProcess(normalized).stream()
                .map(SegToken::word)
                .filter(w -> w.length() > 1 && !STOP_WORDS.contains(w)) // è¿‡æ»¤å•å­—å’Œåœç”¨è¯
                .collect(Collectors.toList());
    }

    // -------------------------------------------------------------------------
    // 2. å‡çº§åŒä¹‰è¯æ‰©å±• (æ•°æ®åº“ + AI æ··åˆæ¨¡å¼)
    // -------------------------------------------------------------------------
    @Transactional(readOnly = true)
    public List<String> expandSynonyms(List<String> keywords) {
        if (keywords == null || keywords.isEmpty()) return new ArrayList<>();
        
        Set<String> expandedKeywords = new HashSet<>(keywords);
        
        for (String keyword : keywords) {
            // A. æŸ¥æ•°æ®åº“ (åŸæœ‰é€»è¾‘ - ç²¾ç¡®æ˜ å°„)
            List<SymptomSynonym> synonyms = synonymRepository.findBySymptomKeyword(keyword);
            synonyms.forEach(s -> expandedKeywords.add(s.getSynonym()));
            
            List<SymptomSynonym> reverseSynonyms = synonymRepository.findBySynonym(keyword);
            reverseSynonyms.forEach(s -> expandedKeywords.add(s.getSymptomKeyword()));

            // B. AI è¯­ä¹‰è”æƒ³ (æ–°å¢é€»è¾‘ - æ¨¡ç³Šå¬å›)
            if (wordVectorService.isReady()) {
                // å¦‚æœæ˜¯æ²¡è§è¿‡çš„è¯ï¼Œè®© AI æ‰¾ 3 ä¸ªæœ€ç›¸ä¼¼çš„è¯
                Collection<String> aiSynonyms = wordVectorService.findNearestWords(keyword, 3);
                if (!aiSynonyms.isEmpty()) {
                    expandedKeywords.addAll(aiSynonyms);
                    logger.debug("ğŸ¤– AI ä¸º '{}' è”æƒ³äº†: {}", keyword, aiSynonyms);
                }
            }
        }
        return new ArrayList<>(expandedKeywords);
    }

    // -------------------------------------------------------------------------
    // 3. å‡çº§ç›¸ä¼¼åº¦è®¡ç®— (æ ¸å¿ƒå‡çº§)
    // -------------------------------------------------------------------------
    public double calculateSymptomMatch(List<String> symptoms, String text) {
        if (symptoms == null || symptoms.isEmpty() || text == null || text.trim().isEmpty()) {
            return 0.0;
        }

        // åœºæ™¯ A: AI æ¨¡å‹æœªå°±ç»ª -> é™çº§ä¸ºåŸæœ‰è¯é¢‘åŒ¹é…
        if (!wordVectorService.isReady()) {
            List<String> textWords = segmentText(text);
            return CosineSimilarityCalculator.cosineSimilarity(symptoms, textWords);
        }

        // åœºæ™¯ B: AI å‘é‡åŒ¹é…
        INDArray symptomVector = wordVectorService.encodeText(symptoms);
        INDArray textVector = wordVectorService.encodeText(segmentText(text));
        
        // è®¡ç®—è¯­ä¹‰ç›¸ä¼¼åº¦
        double similarity = wordVectorService.calculateSimilarity(symptomVector, textVector);
        
        // åœºæ™¯ C: ä¿åº•ç­–ç•¥
        // å¦‚æœ AI åˆ¤å®šç›¸ä¼¼åº¦ä½ (<0.5)ï¼Œä½†å­˜åœ¨å®Œå…¨ç›¸åŒçš„å…³é”®è¯ï¼Œå¼ºåˆ¶ç»™ä¸€ä¸ªåŠæ ¼åˆ†
        List<String> textWords = segmentText(text);
        boolean hasExactMatch = textWords.stream().anyMatch(symptoms::contains);
        if (hasExactMatch && similarity < 0.5) {
            return 0.5; 
        }

        return Math.max(0.0, similarity);
    }

    // -------------------------------------------------------------------------
    // 4. ä¿®å¤ Bug (recommendDepartments æ–¹æ³•)
    // -------------------------------------------------------------------------
    // è¯·æ‰¾åˆ° recommendDepartments æ–¹æ³•ï¼Œå°†ç¬¬ 236 è¡Œå·¦å³çš„ä»£ç ï¼š
    // List<String> symptomKeywords = nlpService.extractSymptomKeywords(symptomDescription);
    // ä¿®æ”¹ä¸ºï¼š
    // List<String> symptomKeywords = this.extractSymptomKeywords(symptomDescription);
```

-----

## ğŸ§  ç¬¬å››æ­¥ï¼šæ·»åŠ å‘é‡ç¼“å­˜ (RecommendationAlgorithmService)

**ä¿®æ”¹ç°æœ‰æ–‡ä»¶**ã€‚è¿™æ˜¯å®ç°â€œæ¯” API å¿«â€çš„å…³é”®ã€‚æˆ‘ä»¬åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ï¼ŒæŠŠæ‰€æœ‰åŒ»ç”Ÿçš„æ“…é•¿é¢†åŸŸé¢„å…ˆç®—å¥½å­˜å…¥å†…å­˜ï¼Œé¿å…è¿è¡Œæ—¶é‡å¤è®¡ç®—ã€‚

**æ–‡ä»¶è·¯å¾„**ï¼š`springboot/src/main/java/com/example/springboot/service/RecommendationAlgorithmService.java`

```java
// å¯¼å…¥éœ€è¦çš„åŒ…
import org.nd4j.linalg.api.ndarray.INDArray;
import javax.annotation.PostConstruct;
import java.util.concurrent.ConcurrentHashMap;
import java.util.Map;

// ... åœ¨ç±»å†…éƒ¨ ...

    @Autowired
    private WordVectorService wordVectorService; // <--- æ³¨å…¥ AI æœåŠ¡

    // âœ… å†…å­˜ç¼“å­˜ï¼šåŒ»ç”ŸID -> è¯­ä¹‰å‘é‡
    private final Map<Integer, INDArray> doctorVectorCache = new ConcurrentHashMap<>();

    // -------------------------------------------------------------------------
    // 1. åˆå§‹åŒ–ç¼“å­˜ (ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ)
    // -------------------------------------------------------------------------
    @PostConstruct
    public void initDoctorVectors() {
        if (!wordVectorService.isReady()) {
            logger.info("âš ï¸ AI æ¨¡å‹æœªå°±ç»ªï¼Œè·³è¿‡åŒ»ç”Ÿå‘é‡é¢„è®¡ç®—ï¼ˆå°†ä½¿ç”¨æ™®é€šåŒ¹é…ï¼‰ã€‚");
            return;
        }
        
        logger.info("ğŸš€ å¼€å§‹é¢„è®¡ç®—åŒ»ç”Ÿç‰¹å¾å‘é‡...");
        List<Doctor> doctors = doctorRepository.findAll();
        refreshDoctorVectorCache(doctors);
    }

    // åˆ·æ–°ç¼“å­˜çš„æ–¹æ³• (å½“åŒ»ç”Ÿä¿¡æ¯æ›´æ–°æ—¶ä¹Ÿå¯è°ƒç”¨æ­¤æ–¹æ³•)
    public void refreshDoctorVectorCache(List<Doctor> doctors) {
        int count = 0;
        for (Doctor doc : doctors) {
            if (doc.getSpecialty() != null && !doc.getSpecialty().isEmpty()) {
                // A. è°ƒç”¨ NLP æœåŠ¡è¿›è¡Œåˆ†è¯
                List<String> keywords = nlpService.segmentText(doc.getSpecialty());
                // B. è°ƒç”¨ AI æœåŠ¡è½¬ä¸ºå‘é‡
                INDArray vector = wordVectorService.encodeText(keywords);
                
                if (vector != null) {
                    doctorVectorCache.put(doc.getDoctorId(), vector);
                    count++;
                }
            }
        }
        logger.info("âœ… å·²æ„å»º {} ä½åŒ»ç”Ÿçš„ AI è¯­ä¹‰ç´¢å¼•ã€‚", count);
    }

    // -------------------------------------------------------------------------
    // 2. é‡å†™ç›¸ä¼¼åº¦è®¡ç®— (ä¼˜å…ˆä½¿ç”¨ç¼“å­˜)
    // -------------------------------------------------------------------------
    @Override // å¦‚æœæœ‰æ¥å£çš„è¯
    public double calculateSimilarity(List<String> symptoms, Doctor doctor) {
        // é™çº§åˆ¤æ–­ï¼šæ¨¡å‹æœªåŠ è½½ OR è¯¥åŒ»ç”Ÿæ— ç¼“å­˜ -> å›é€€åˆ°æ™®é€šåŒ¹é…
        if (!wordVectorService.isReady() || !doctorVectorCache.containsKey(doctor.getDoctorId())) {
            return nlpService.calculateSymptomMatch(symptoms, doctor.getSpecialty());
        }

        // A. å®æ—¶è®¡ç®—æ‚£è€…è¾“å…¥çš„å‘é‡
        INDArray userVector = wordVectorService.encodeText(symptoms);
        if (userVector == null) return 0.0;

        // B. ä»ç¼“å­˜ç›´æ¥è·å–åŒ»ç”Ÿå‘é‡ (çº³ç§’çº§)
        INDArray doctorVector = doctorVectorCache.get(doctor.getDoctorId());

        // C. è®¡ç®—å¹¶è¿”å›ç›¸ä¼¼åº¦
        return wordVectorService.calculateSimilarity(userVector, doctorVector);
    }
```

-----

## âš™ï¸ ç¬¬äº”æ­¥ï¼šé…ç½®æ–‡ä»¶ (application.yml)

é…ç½®æ¨¡å‹æ–‡ä»¶çš„è·¯å¾„ã€‚

**æ–‡ä»¶è·¯å¾„**ï¼š`springboot/src/main/resources/application.yml`

```yaml
# æ–°å¢ AI é…ç½®å—
ai:
  model:
    # æ¨¡å‹æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•ï¼‰
    path: models/medical_word2vec.bin
```

-----

## ğŸ“‚ ç¬¬å…­æ­¥ï¼šæ¨¡å‹æ–‡ä»¶éƒ¨ç½² (éå¸¸é‡è¦)

ä»£ç å†™å¥½äº†ï¼Œå¿…é¡»è¦æœ‰â€œå¤§è„‘â€æ‰èƒ½è¿è¡Œã€‚

1.  **ä¸‹è½½æ¨¡å‹**ï¼š
      * æ¨èä¸‹è½½å¼€æºçš„ **ä¸­æ–‡ç»´åŸºç™¾ç§‘ Word2Vec æ¨¡å‹** (binary/bin æ ¼å¼)ã€‚
      * ä¸‹è½½åœ°å€å‚è€ƒï¼šGitHub `Chinese-Word-Vectors` é¡¹ç›®ã€‚
2.  **é‡å‘½åä¸æ”¾ç½®**ï¼š
      * åœ¨ `springboot` é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶å¤¹ `models`ã€‚
      * å°†ä¸‹è½½çš„ `.bin` æ–‡ä»¶é‡å‘½åä¸º `medical_word2vec.bin` å¹¶æ”¾å…¥è¯¥æ–‡ä»¶å¤¹ã€‚
      * æœ€ç»ˆè·¯å¾„åº”ä¸ºï¼š`YourProject/springboot/models/medical_word2vec.bin`ã€‚

-----

## âœ… éªŒè¯æ–¹æ¡ˆ

1.  **å¯åŠ¨ Spring Boot**ã€‚
2.  **è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—**ï¼š
      * çœ‹åˆ° `æ­£åœ¨åŠ è½½ AI è¯­ä¹‰æ¨¡å‹...`
      * çº¦ 3-5 ç§’åçœ‹åˆ° `âœ… æ¨¡å‹åŠ è½½æˆåŠŸï¼è¯æ±‡é‡: XXXXX`
      * éšåçœ‹åˆ° `âœ… å·²æ„å»º XX ä½åŒ»ç”Ÿçš„ AI è¯­ä¹‰ç´¢å¼•`
3.  **æ¥å£æµ‹è¯• (Postman)**ï¼š
      * å‘é€è¯·æ±‚ï¼š`POST /api/doctor-recommendations`
      * Body: `{"symptomDescription": "æ„Ÿè§‰èƒ¸å£é—·é—·çš„ï¼Œæœ‰æ—¶å€™åƒé’ˆæ‰ä¸€æ ·ç–¼"}`
      * **é¢„æœŸç»“æœ**ï¼šå³ä½¿æè¿°ä¸­æ²¡æœ‰å‡ºç°â€œå¿ƒç»ç—›â€æˆ–â€œå† å¿ƒç—…â€è¿™äº›è¯ï¼Œç³»ç»Ÿä¹Ÿèƒ½é€šè¿‡å‘é‡ç›¸ä¼¼åº¦æ¨èâ€œå¿ƒè¡€ç®¡å†…ç§‘â€çš„åŒ»ç”Ÿã€‚