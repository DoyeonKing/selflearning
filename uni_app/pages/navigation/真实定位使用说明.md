# 真实定位导航功能使用说明

## 功能概述

已实现真实定位导航功能，支持三种定位方式：
1. **GPS定位** - 使用手机GPS获取当前位置（适合室外或粗略定位）
2. **手动选择位置** - 从预设节点中选择当前位置
3. **二维码扫码定位** - 扫描医院内的定位二维码

## 配置步骤

### 1. 设置地图坐标范围（重要！）

在 `pages/navigation/index.vue` 中找到 `mapBounds` 配置，根据实际医院位置修改：

```javascript
mapBounds: {
    minLat: 39.9,  // 最小纬度（需要根据实际医院位置修改）
    maxLat: 40.0,  // 最大纬度
    minLng: 116.3, // 最小经度
    maxLng: 116.4  // 最大经度
}
```

**如何获取医院坐标范围：**
1. 使用高德地图或百度地图，找到医院位置
2. 获取医院四个角的GPS坐标
3. 取最小/最大纬度和经度填入配置

**示例：**
- 医院中心坐标：纬度 39.95，经度 116.35
- 医院范围：约 100米 x 100米
- 配置：
  ```javascript
  minLat: 39.945,  // 中心纬度 - 0.005
  maxLat: 39.955,  // 中心纬度 + 0.005
  minLng: 116.345, // 中心经度 - 0.005
  maxLng: 116.355  // 中心经度 + 0.005
  ```

### 2. 权限配置

已自动添加定位权限配置：
- Android: `ACCESS_FINE_LOCATION`, `ACCESS_COARSE_LOCATION`
- iOS: 需要在 `manifest.json` 的 `ios` 配置中添加定位权限说明
- 微信小程序: 已配置 `scope.userLocation`

## 使用方法

### 方式一：GPS定位（推荐用于室外）

1. 点击"📍 定位当前位置"按钮
2. 授权定位权限（首次使用）
3. 系统自动获取GPS坐标并转换为地图网格坐标
4. 自动更新起点并重新计算路径
5. 开启实时定位模式，每5秒更新一次位置

**注意事项：**
- GPS定位精度有限（通常5-20米），室内可能不准确
- 如果定位失败，会提示使用手动选择位置
- 实时定位会消耗电量，到达目的地后建议关闭

### 方式二：手动选择位置（推荐用于室内）

1. 点击"📌 手动选择位置"按钮
2. 从弹出的列表中选择当前位置（如"医院大门"、"分诊台"等）
3. 系统自动更新起点并重新计算路径

**优点：**
- 最准确，适合室内使用
- 不依赖GPS，不消耗电量
- 适合在关键位置（如大门、电梯口）手动更新位置

### 方式三：二维码扫码定位（最精确）

1. 在医院关键位置张贴定位二维码
2. 点击"📷 扫码定位"按钮
3. 扫描二维码
4. 系统自动识别位置并更新起点

**二维码格式：**
```
HOSPITAL_NODE_1
HOSPITAL_NODE_2
...
```

**生成二维码：**
可以使用在线二维码生成器，内容格式：`HOSPITAL_NODE_{nodeId}`

例如：
- `HOSPITAL_NODE_1` - 医院大门
- `HOSPITAL_NODE_2` - 分诊台
- `HOSPITAL_NODE_4` - 内科诊室

## 功能特性

### 实时定位模式

开启GPS定位后，系统会：
- 每5秒自动更新一次位置
- 根据实际位置重新计算路径
- 实时更新剩余距离
- 显示定位精度圆圈（红色半透明圆圈）

### 路径自动更新

当位置改变时：
- 自动重新计算从当前位置到终点的最短路径
- 更新路径显示
- 更新剩余距离

### 定位状态显示

页面顶部会显示：
- 定位状态（"正在定位..."、"定位成功"、"定位失败"等）
- 定位精度（GPS定位时显示）

## 测试步骤

### 1. 测试GPS定位

1. 确保已配置正确的 `mapBounds`
2. 在室外或GPS信号好的地方打开导航页面
3. 点击"📍 定位当前位置"
4. 授权定位权限
5. 观察是否成功定位并显示路径

### 2. 测试手动选择位置

1. 打开导航页面
2. 点击"📌 手动选择位置"
3. 选择"医院大门"
4. 观察起点是否更新，路径是否重新计算

### 3. 测试二维码定位

1. 准备一个二维码，内容为 `HOSPITAL_NODE_1`
2. 打开导航页面
3. 点击"📷 扫码定位"
4. 扫描二维码
5. 观察是否定位到"医院大门"

## 常见问题

### Q1: GPS定位失败怎么办？

**原因：**
- 未授权定位权限
- GPS信号弱（室内）
- 坐标不在医院范围内

**解决方案：**
- 使用"手动选择位置"功能
- 在设置中开启定位权限
- 检查 `mapBounds` 配置是否正确

### Q2: 定位不准确怎么办？

**原因：**
- GPS精度有限（通常5-20米）
- 室内GPS信号弱

**解决方案：**
- 使用"手动选择位置"功能（最准确）
- 使用"二维码扫码定位"（最精确）
- 在关键位置（如电梯口、分诊台）手动更新位置

### Q3: 如何提高定位精度？

**方案：**
1. **蓝牙/iBeacon定位**（需要硬件支持）
   - 在医院内安装蓝牙信标
   - 通过蓝牙信号强度计算位置
   - 精度可达1-3米

2. **WiFi定位**（需要WiFi指纹库）
   - 建立WiFi信号强度指纹库
   - 通过WiFi信号匹配位置
   - 精度可达3-5米

3. **二维码定位**（最简单实用）
   - 在关键位置张贴二维码
   - 扫码即可精确定位
   - 精度最高（0米误差）

### Q4: 如何添加更多定位节点？

在 `MapService.java` 中添加新节点：

```java
nodes.add(new MapNodeDTO(6, "新位置", 10, 15, null));
```

然后在导航页面中就可以选择这个位置了。

## 性能优化建议

1. **定位频率**
   - 当前设置为每5秒更新一次
   - 可以根据需要调整（在 `startRealTimeLocation` 方法中修改间隔）

2. **电量消耗**
   - GPS定位会消耗电量
   - 建议到达目的地后关闭实时定位
   - 或使用手动选择位置功能

3. **网络请求**
   - 定位不需要网络请求
   - 只有获取地图配置和目标节点需要网络

## 扩展开发

### 集成蓝牙/iBeacon定位

如果需要更高精度的室内定位，可以集成蓝牙定位：

```javascript
// 示例代码（需要安装蓝牙插件）
uni.startBeaconDiscovery({
  success: (res) => {
    // 扫描蓝牙信标
    // 根据信号强度计算位置
  }
})
```

### 集成WiFi定位

```javascript
// 示例代码
uni.getConnectedWifi({
  success: (res) => {
    // 获取WiFi信息
    // 发送到后端匹配位置
  }
})
```

## 总结

真实定位导航功能已完整实现，支持三种定位方式：
- ✅ GPS定位（室外/粗略定位）
- ✅ 手动选择位置（最实用）
- ✅ 二维码扫码定位（最精确）

根据实际需求选择合适的定位方式即可。

















