# ç¼–è¯‘é”™è¯¯ä¿®å¤è¯´æ˜

## ğŸ”§ é—®é¢˜æè¿°

åç«¯ç¼–è¯‘æ—¶å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
1. âŒ æ‰¾ä¸åˆ° `NotificationService` çš„ `sendToDoctor` å’Œ `sendToPatient` æ–¹æ³•
2. âŒ `handlePaymentSuccessAsync` æ–¹æ³•å‚æ•°ç±»å‹é”™è¯¯

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### é—®é¢˜1ï¼šNotificationServiceæ–¹æ³•ä¸å­˜åœ¨

**åŸå› **ï¼š
- `NotificationService` æ²¡æœ‰ `sendToDoctor()` å’Œ `sendToPatient()` è¿™æ ·çš„ç®€åŒ–æ–¹æ³•
- éœ€è¦ä½¿ç”¨ `createNotification()` æ–¹æ³•ï¼Œå¹¶ä¼ å…¥å®Œæ•´çš„ `NotificationCreateRequest` å¯¹è±¡

**ä¿®å¤**ï¼š
ä¿®æ”¹äº†ä»¥ä¸‹æ–‡ä»¶ä¸­çš„é€šçŸ¥å‘é€ä»£ç ï¼š

#### 1. AddOnSlotService.java
```java
// âŒ é”™è¯¯çš„è°ƒç”¨æ–¹å¼
notificationService.sendToDoctor(doctorId, title, content);
notificationService.sendToPatient(patientId, title, content);

// âœ… æ­£ç¡®çš„è°ƒç”¨æ–¹å¼
NotificationCreateRequest notification = new NotificationCreateRequest();
notification.setUserId(userId);
notification.setUserType(UserType.doctor); // æˆ– UserType.patient
notification.setType(NotificationType.system_notice);
notification.setTitle(title);
notification.setContent(content);
notification.setRelatedEntity("slot_application");
notification.setRelatedId(relatedId);
notification.setPriority(NotificationPriority.normal);
notificationService.createNotification(notification);
```

#### 2. AddOnPaymentExpirationTask.java
åŒæ ·ä¿®æ”¹äº†è¶…æ—¶é€šçŸ¥çš„å‘é€æ–¹å¼ã€‚

---

## ğŸ“‹ ä¿®æ”¹çš„æ–‡ä»¶

### 1. AddOnSlotService.java
**ä¿®æ”¹ä½ç½®**ï¼š
- `sendNotifications()` æ–¹æ³•ï¼ˆç¬¬171-212è¡Œï¼‰
- `handlePaymentSuccess()` æ–¹æ³•ï¼ˆç¬¬250-266è¡Œï¼‰

**ä¿®æ”¹å†…å®¹**ï¼š
- âœ… é€šçŸ¥åŒ»ç”Ÿï¼šä½¿ç”¨ `createNotification()` åˆ›å»ºç³»ç»Ÿé€šçŸ¥
- âœ… é€šçŸ¥æ‚£è€…ï¼šä½¿ç”¨ `createNotification()` åˆ›å»ºé¢„çº¦æˆåŠŸé€šçŸ¥
- âœ… æ”¯ä»˜æˆåŠŸé€šçŸ¥ï¼šä½¿ç”¨ `createNotification()` åˆ›å»ºæ”¯ä»˜æˆåŠŸé€šçŸ¥

### 2. AddOnPaymentExpirationTask.java
**ä¿®æ”¹ä½ç½®**ï¼š
- `processExpiredAppointment()` æ–¹æ³•ï¼ˆç¬¬112-134è¡Œï¼‰

**ä¿®æ”¹å†…å®¹**ï¼š
- âœ… è¶…æ—¶é€šçŸ¥ï¼šä½¿ç”¨ `createNotification()` åˆ›å»ºå–æ¶ˆé€šçŸ¥

---

## ğŸ¯ é€šçŸ¥ç±»å‹æ˜ å°„

| åœºæ™¯ | UserType | NotificationType | Priority |
|------|----------|------------------|----------|
| å®¡æ‰¹é€šè¿‡-é€šçŸ¥åŒ»ç”Ÿ | `doctor` | `system_notice` | `normal` |
| å®¡æ‰¹é€šè¿‡-é€šçŸ¥æ‚£è€… | `patient` | `appointment_success` | `urgent` |
| æ”¯ä»˜æˆåŠŸ | `patient` | `payment_success` | `high` |
| æ”¯ä»˜è¶…æ—¶ | `patient` | `cancellation` | `high` |

---

## âœ… éªŒè¯æ¸…å•

- [x] AddOnSlotService.java ç¼–è¯‘é€šè¿‡
- [x] AddOnPaymentExpirationTask.java ç¼–è¯‘é€šè¿‡
- [x] é€šçŸ¥ç±»å‹æ­£ç¡®æ˜ å°„
- [x] é€šçŸ¥ä¼˜å…ˆçº§æ­£ç¡®è®¾ç½®
- [x] å¼‚å¸¸å¤„ç†ä¿ç•™ï¼ˆé€šçŸ¥å¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼‰

---

## ğŸš€ æµ‹è¯•å»ºè®®

### 1. æµ‹è¯•é€šçŸ¥å‘é€
```bash
# 1. æ‰¹å‡†åŠ å·ç”³è¯·
PUT /api/slot-applications/{id}
{
  "status": "APPROVED",
  "approverId": 1
}

# 2. æ£€æŸ¥æ•°æ®åº“ notifications è¡¨
SELECT * FROM notifications 
WHERE user_type = 'doctor' AND type = 'system_notice'
ORDER BY sent_at DESC LIMIT 1;

SELECT * FROM notifications 
WHERE user_type = 'patient' AND type = 'appointment_success'
ORDER BY sent_at DESC LIMIT 1;
```

### 2. æµ‹è¯•æ”¯ä»˜æˆåŠŸé€šçŸ¥
```java
// è°ƒç”¨æ”¯ä»˜æˆåŠŸæ–¹æ³•
addOnSlotService.handlePaymentSuccess(appointmentId, "ALIPAY", "TX123456");

// æ£€æŸ¥é€šçŸ¥
SELECT * FROM notifications 
WHERE type = 'payment_success'
ORDER BY sent_at DESC LIMIT 1;
```

### 3. æµ‹è¯•è¶…æ—¶é€šçŸ¥
```bash
# 1. ä¿®æ”¹æ”¯ä»˜æˆªæ­¢æ—¶é—´ä¸ºè¿‡å»
UPDATE appointments 
SET payment_deadline = '2025-01-01 00:00:00' 
WHERE appointment_id = ?;

# 2. ç­‰å¾…å®šæ—¶ä»»åŠ¡æ‰§è¡Œï¼ˆ1åˆ†é’Ÿï¼‰

# 3. æ£€æŸ¥é€šçŸ¥
SELECT * FROM notifications 
WHERE type = 'cancellation'
ORDER BY sent_at DESC LIMIT 1;
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **Long è½¬ Integer**
   ```java
   // patientId æ˜¯ Long ç±»å‹ï¼Œéœ€è¦è½¬æ¢
   notification.setUserId(application.getPatientId().intValue());
   ```

2. **å¼‚å¸¸å¤„ç†**
   ```java
   try {
       notificationService.createNotification(notification);
   } catch (Exception e) {
       logger.error("å‘é€é€šçŸ¥å¤±è´¥", e);
       // é€šçŸ¥å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
   }
   ```

3. **å…³è”å®ä½“**
   - åŠ å·ç”³è¯·ç›¸å…³ï¼š`relatedEntity = "slot_application"`
   - é¢„çº¦ç›¸å…³ï¼š`relatedEntity = "appointment"`

---

## âœ… ä¿®å¤å®Œæˆ

æ‰€æœ‰ç¼–è¯‘é”™è¯¯å·²ä¿®å¤ï¼ç°åœ¨å¯ä»¥ï¼š
1. âœ… ç¼–è¯‘é€šè¿‡
2. âœ… å¯åŠ¨åç«¯æœåŠ¡
3. âœ… æµ‹è¯•åŠ å·å®¡æ‰¹æµç¨‹
4. âœ… æµ‹è¯•é€šçŸ¥å‘é€åŠŸèƒ½

ğŸ‰ ä¿®å¤å®Œæˆï¼
