# 医院挂号叫号规则总览

## 一、预约类型

系统支持以下预约类型：
1. **预约挂号** (`APPOINTMENT`)：提前预约的号
2. **现场挂号** (`WALK_IN`)：当天现场挂的号
3. **当日复诊号** (`SAME_DAY_FOLLOW_UP`)：当天复诊的号
4. **加号** (`ADD_ON`)：医生同意后加的号

> ⚠️ **注意**：不支持隔日复诊，只有当日复诊有效

## 二、签到时间规则

### 签到时间窗口
- **开始时间**：时段开始前 **30分钟**
- **截止时间**：时段结束前 **10分钟**
- **时段结束后**：不能签到，需改约或退号

### 示例
假设时段是 **8:00-8:30**：

| 时间范围 | 状态 | 说明 |
|---------|------|------|
| **7:30 之前** | ❌ 不能签到 | 签到时间未到 |
| **7:30 - 8:20** | ✅ 按时签到 | 正常签到，按规则排序 |
| **8:20 - 8:30** | ⚠️ 迟到签到 | 允许签到，但标记为迟到，排在队尾 |
| **8:30 之后** | ❌ 不能签到 | 时段已结束，需改约或退号 |

### 迟到处理
- **未跨场但迟到**：允许签到，标记为迟到，排在当前时段队尾
- **跨场迟到**：直接作废预约，需重新挂号
  - 跨场定义：上午场（12:00前）或下午场（18:00前）已结束

## 三、排队排序规则（按优先级从高到低）

### 1. 预约挂号 vs 现场挂号
- **预约挂号** 永远排在 **现场挂号** 之前
- 即使现场挂号患者签到更早，预约挂号患者仍然优先

### 2. 提前签到 vs 时段内签到
- **提前签到**（时段开始前）：按 **挂号序号** 排序
  - 例如：1号在7:45签到，2号在7:50签到 → 1号在前，2号在后
- **时段内签到**（时段开始后）：按 **签到时间** 排序（先签到先就诊）
  - 例如：时段8:00开始，2号在8:05签到，1号在8:10签到 → 2号在前，1号在后

### 3. 按时签到 vs 迟到签到
- **按时签到**：正常排序（提前按序号，时段内按时间）
- **迟到签到**：排在当前时段队尾

### 4. 当日复诊号插入规则
- **同医生复诊**：每两位正常挂号患者之后插入一个复诊号
  - 例如：正常队列是 1、2、3、4、5号，复诊号是A、B
  - 最终队列：1、2、A、3、4、B、5
- **不同医生复诊**：排在该医生所有患者的最后面
  - 例如：医生当前有25位患者，复诊号就是第26号

### 5. 过号处理
- **定义**：医生叫号后，患者未在规定时间内到诊室
- **处理**：患者需到分诊台重新扫码签到
- **排序**：排在当前时段队尾（按重新签到时间排序）

### 6. 加号
- **创建**：医生端紧急加号（号满时医生直接创建）
- **缴费**：患者需线下缴费后才能签到就诊
- **排序**：排在所有正常号（预约/现场/复诊）的最后面
- **限制**：每个医生每日加号上限5个
- **流程**：医生创建加号（待支付） → 患者线下缴费 → 患者签到 → 就诊

## 四、最终队列排序示例

假设某时段有以下患者：

**正常预约和现场挂号**：
- 预约1号（提前签到，7:45）
- 预约2号（提前签到，7:50）
- 现场3号（时段内签到，8:05）
- 预约4号（时段内签到，8:10）

**复诊号**：
- 复诊A（同医生）
- 复诊B（不同医生）

**过号**：
- 过号C（重新签到，8:15）

**加号**：
- 加号D

**最终队列顺序**：
1. 预约1号（提前签到，按序号）
2. 预约2号（提前签到，按序号）
3. 复诊A（每两位后插入）
4. 预约3号（时段内签到，按时间）
5. 预约4号（时段内签到，按时间）
6. 复诊B（不同医生，排最后）
7. 过号C（过号，排最后）
8. 加号D（加号，排最后）

## 五、关键时间点总结

| 时间点 | 说明 |
|--------|------|
| **时段开始前30分钟** | 可以开始签到 |
| **时段开始时间** | 时段正式开始 |
| **时段结束前10分钟** | 签到截止时间（之后算迟到） |
| **时段结束时间** | 时段结束，不能签到 |

## 六、特殊情况处理

### 1. 跨场迟到
- **定义**：超过上午场（12:00）或下午场（18:00）结束时间
- **处理**：预约直接作废，需重新挂号

### 2. 过号重排
- **触发**：医生叫号后患者未到诊室
- **处理**：重新扫码签到，排当前时段队尾
- **序号**：就诊序号不变，但实时候诊序号重新分配

### 3. 迟到签到
- **时间**：时段结束前10分钟之后，但未到时段结束
- **处理**：允许签到，但标记为迟到，排在队尾

## 七、规则优先级总结

```
1. 预约挂号 > 现场挂号
2. 提前签到（按序号）> 时段内签到（按时间）
3. 按时签到 > 迟到签到
4. 正常号 > 复诊号（同医生插入）> 复诊号（不同医生）> 过号 > 加号
```

