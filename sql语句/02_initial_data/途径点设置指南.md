# 途径点设置指南

## 📋 概述

途径点（Waypoints）是地理导航系统中的关键节点，用于路径规划。除了目的地（诊室），还需要设置途径点来连接各个位置。

## 🎯 途径点的作用

1. **路径规划**：A*算法需要节点之间的连接关系来计算最短路径
2. **导航指引**：告诉用户"向前走20米，在电梯口左转"
3. **跨楼层导航**：通过电梯/楼梯节点实现楼层切换
4. **精确定位**：每个途径点可以放置二维码，用于扫码定位

## 📊 途径点类型

### 1. 入口节点（ENTRANCE）
- **作用**：导航起点
- **示例**：医院正门、侧门、急诊入口
- **是否需要二维码**：✅ 是（用于确定起点）

### 2. 走廊节点（HALLWAY）
- **作用**：路径规划的关键节点，连接各个诊室
- **示例**：
  - 主走廊起点/中段/终点
  - 东走廊、西走廊
  - 走廊拐角点
- **是否需要二维码**：可选（建议在关键拐角点设置）

### 3. 电梯节点（ELEVATOR）
- **作用**：跨楼层导航
- **示例**：1号电梯-1楼、1号电梯-2楼
- **是否需要二维码**：✅ 是（每层电梯口都需要）

### 4. 楼梯节点（STAIRS）
- **作用**：跨楼层导航（备用）
- **示例**：1号楼梯-1楼、1号楼梯-2楼
- **是否需要二维码**：可选（如果使用楼梯导航）

### 5. 诊室节点（ROOM）
- **作用**：目的地
- **示例**：门诊楼201室、外科楼101室
- **是否需要二维码**：✅ 是（用于确认到达）

## 🔧 设置步骤

### 步骤1：执行SQL脚本

```bash
# 执行途径点和路径初始化脚本
mysql -u root -p123456 hospital_05 < sql语句/02_initial_data/init_waypoints_and_paths.sql
```

### 步骤2：根据实际情况调整

脚本中提供的是示例数据，需要根据医院实际布局调整：

1. **坐标调整**：根据实际平面图设置 `coordinates_x` 和 `coordinates_y`
2. **节点名称**：使用医院实际的命名（如"门诊楼1楼东走廊"）
3. **路径连接**：根据实际通道连接关系设置 `map_edges`

### 步骤3：连接诊室到途径点

每个诊室（location）需要连接到最近的走廊节点：

```sql
-- 示例：将1楼的诊室连接到最近的走廊节点
INSERT INTO `map_edges` (`start_node_id`, `end_node_id`, `distance`, `walk_time`, `is_bidirectional`, `accessibility_info`) 
SELECT 
    n.node_id,  -- 走廊节点ID
    l.map_node_id,  -- 诊室对应的节点ID
    5.0,  -- 距离（米）
    6,    -- 步行时间（秒）
    TRUE, -- 双向通行
    '诊室连接'
FROM `map_nodes` n, `locations` l
WHERE n.node_name = '1楼东走廊终点'  -- 最近的走廊节点
  AND l.map_node_id IS NOT NULL
  AND l.floor_level = 1;
```

### 步骤4：生成途径点二维码

使用二维码生成工具为途径点生成二维码：

1. 打开 `tools/qrcode_generator.html`
2. 点击"刷新位置数据"
3. 系统会自动加载所有节点（包括途径点）
4. 下载并打印二维码
5. 在对应位置张贴

## 📐 路径连接原则

### 1. 同层连接
- 走廊节点之间按顺序连接
- 诊室连接到最近的走廊节点
- 入口连接到主走廊

### 2. 跨层连接
- 电梯节点：1楼电梯 ↔ 2楼电梯 ↔ 3楼电梯
- 楼梯节点：1楼楼梯 ↔ 2楼楼梯
- 距离设为0，时间设为30秒（电梯）或60秒（楼梯）

### 3. 双向性
- 大部分路径都是双向的（`is_bidirectional = TRUE`）
- 单向路径（如单向门）设为 `FALSE`

## 🗺️ 示例布局

```
1楼布局示例：

[正门] --10米--> [门诊大厅] --10米--> [分诊台]
                                    |
                                    |--10米--> [1号电梯-1楼]
                                    |--10米--> [1号楼梯-1楼]
                                    |--10米--> [主走廊]
                                              |
                                              |--10米--> [东走廊起点] --10米--> [东走廊中段] --10米--> [东走廊终点]
                                              |                                                      |
                                              |                                                      |--5米--> [诊室1]
                                              |
                                              |--10米--> [西走廊起点] --10米--> [西走廊中段] --10米--> [西走廊终点]
                                                                                                      |
                                                                                                      |--5米--> [诊室2]
```

## ✅ 验证数据

执行以下SQL验证数据是否正确：

```sql
-- 1. 检查是否有孤立的节点（没有连接的节点）
SELECT n.node_id, n.node_name, n.node_type
FROM map_nodes n
LEFT JOIN map_edges e1 ON n.node_id = e1.start_node_id
LEFT JOIN map_edges e2 ON n.node_id = e2.end_node_id
WHERE e1.edge_id IS NULL AND e2.edge_id IS NULL
  AND n.node_type != 'room';  -- 诊室可能暂时没有连接

-- 2. 检查每个楼层是否有电梯/楼梯连接
SELECT 
    n.floor_level,
    COUNT(DISTINCT CASE WHEN n.node_type = 'elevator' THEN n.node_id END) AS 电梯数,
    COUNT(DISTINCT CASE WHEN n.node_type = 'stairs' THEN n.node_id END) AS 楼梯数
FROM map_nodes n
GROUP BY n.floor_level;

-- 3. 检查路径连通性（从入口能否到达所有诊室）
-- 这个需要运行路径规划算法来验证
```

## 🎨 最佳实践

1. **关键节点优先**：先设置入口、电梯、主走廊等关键节点
2. **逐步细化**：先建立主要路径，再添加细节节点
3. **测试验证**：设置完成后，使用导航功能测试路径规划
4. **定期更新**：如果医院布局改变，及时更新节点和路径

## 📝 注意事项

1. **坐标系统**：确保所有节点的坐标在同一坐标系下
2. **距离单位**：`distance` 单位是米，`walk_time` 单位是秒
3. **节点唯一性**：每个物理位置只对应一个节点
4. **路径合理性**：确保路径连接符合实际建筑布局



