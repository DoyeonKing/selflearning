# åŠ å·åŠŸèƒ½ä¸å€™è¡¥åŠŸèƒ½å®ç°å¯¹æ¯”

## ğŸ“Š æ ¸å¿ƒè®¾è®¡æ€è·¯

ä¸¤ä¸ªåŠŸèƒ½éƒ½é‡‡ç”¨**æ—¶é—´é™åˆ¶ + å®šæ—¶ä»»åŠ¡æ£€æŸ¥**çš„æ¨¡å¼ï¼Œé¿å…åˆ›å»ºé¢å¤–çš„å¤æ‚è¡¨ç»“æ„ã€‚

---

## ğŸ”„ å€™è¡¥ï¼ˆWaitlistï¼‰å®ç°æ–¹å¼

### æ•°æ®åº“è®¾è®¡
```sql
CREATE TABLE `waitlist` (
  `waitlist_id` INT PRIMARY KEY AUTO_INCREMENT,
  `patient_id` INT NOT NULL,
  `schedule_id` INT NOT NULL,
  `status` ENUM('waiting','notified','expired','booked'),
  `notification_sent_at` DATETIME,  -- â­ å…³é”®å­—æ®µï¼šé€šçŸ¥å‘é€æ—¶é—´
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

### æµç¨‹
1. **å·æºé‡Šæ”¾** â†’ é€šçŸ¥å€™è¡¥æ‚£è€…
2. **è®°å½•é€šçŸ¥æ—¶é—´** â†’ `notification_sent_at = NOW()`
3. **çŠ¶æ€å˜æ›´** â†’ `status = 'notified'`
4. **å®šæ—¶ä»»åŠ¡æ£€æŸ¥** â†’ æ¯1åˆ†é’Ÿæ‰§è¡Œ
   ```java
   LocalDateTime expireTime = LocalDateTime.now().minusMinutes(15);
   // æŸ¥è¯¢ notification_sent_at < expireTime ä¸” status = 'notified' çš„è®°å½•
   ```
5. **è¶…æ—¶å¤„ç†** â†’ `status = 'expired'`

### å…³é”®ä»£ç 
```java
@Scheduled(fixedRate = 60000) // æ¯60ç§’
public void checkExpiredWaitlists() {
    LocalDateTime expireTime = LocalDateTime.now().minusMinutes(15);
    List<Waitlist> expired = waitlistRepository.findExpiredNotifiedWaitlists(
        WaitlistStatus.notified, expireTime);
    
    for (Waitlist w : expired) {
        w.setStatus(WaitlistStatus.expired);
        waitlistRepository.save(w);
    }
}
```

---

## ğŸ¯ åŠ å·ï¼ˆAdd-Onï¼‰å®ç°æ–¹å¼ï¼ˆå‚è€ƒå€™è¡¥ï¼‰

### æ•°æ®åº“è®¾è®¡
```sql
-- 1. schedules è¡¨æ·»åŠ å­—æ®µ
ALTER TABLE `schedules` 
ADD COLUMN `is_add_on_slot` TINYINT(1) DEFAULT 0,
ADD COLUMN `reserved_for_patient_id` BIGINT NULL,
ADD COLUMN `slot_application_id` INT NULL;

-- 2. appointments è¡¨æ·»åŠ å­—æ®µ
ALTER TABLE `appointments` 
ADD COLUMN `payment_deadline` DATETIME NULL;  -- â­ å…³é”®å­—æ®µï¼šæ”¯ä»˜æˆªæ­¢æ—¶é—´

-- 3. å¤ç”¨ç°æœ‰å­—æ®µ
-- appointment_type = 'ADD_ON'
-- is_add_on = 1
-- status = 'PENDING_PAYMENT'
-- payment_status = 'unpaid'
```

### æµç¨‹
1. **ç®¡ç†å‘˜æ‰¹å‡†åŠ å·** â†’ åˆ›å»ºè™šæ‹Ÿå·æº + è‡ªåŠ¨ç”Ÿæˆé¢„çº¦
2. **è®¾ç½®æ”¯ä»˜æœŸé™** â†’ `payment_deadline = NOW() + 24å°æ—¶`
3. **çŠ¶æ€è®¾ç½®** â†’ `status = 'PENDING_PAYMENT'`
4. **å®šæ—¶ä»»åŠ¡æ£€æŸ¥** â†’ æ¯1åˆ†é’Ÿæ‰§è¡Œï¼ˆå‚è€ƒå€™è¡¥ï¼‰
   ```java
   LocalDateTime now = LocalDateTime.now();
   // æŸ¥è¯¢ payment_deadline < now ä¸” status = 'PENDING_PAYMENT' çš„è®°å½•
   ```
5. **è¶…æ—¶å¤„ç†** â†’ `status = 'CANCELLED'` + é‡Šæ”¾è™šæ‹Ÿå·æº

### å…³é”®ä»£ç ï¼ˆå‚è€ƒå€™è¡¥å®ç°ï¼‰
```java
@Scheduled(fixedRate = 60000) // æ¯60ç§’
public void checkExpiredAddOnPayments() {
    LocalDateTime now = LocalDateTime.now();
    List<Appointment> expired = appointmentRepository
        .findByAppointmentTypeAndStatusAndPaymentDeadlineBefore(
            AppointmentType.ADD_ON, 
            AppointmentStatus.PENDING_PAYMENT, 
            now
        );
    
    for (Appointment appointment : expired) {
        // 1. å–æ¶ˆé¢„çº¦
        appointment.setStatus(AppointmentStatus.CANCELLED);
        appointmentRepository.save(appointment);
        
        // 2. é‡Šæ”¾è™šæ‹Ÿå·æº
        Schedule virtualSlot = appointment.getSchedule();
        if (virtualSlot.getIsAddOnSlot()) {
            virtualSlot.setStatus(ScheduleStatus.CANCELLED);
            scheduleRepository.save(virtualSlot);
        }
        
        // 3. é€šçŸ¥æ‚£è€…
        notificationService.sendToPatient(
            appointment.getPatient().getPatientId(),
            "åŠ å·å·²å¤±æ•ˆ",
            "ç”±äºæœªåœ¨è§„å®šæ—¶é—´å†…å®Œæˆæ”¯ä»˜ï¼ŒåŠ å·å·²è‡ªåŠ¨å–æ¶ˆ"
        );
    }
}
```

---

## ğŸ“‹ å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§ | å€™è¡¥ï¼ˆWaitlistï¼‰ | åŠ å·ï¼ˆAdd-Onï¼‰ |
|------|-----------------|---------------|
| **æ—¶é—´é™åˆ¶** | 15åˆ†é’Ÿ | 24å°æ—¶ï¼ˆå¯é…ç½®ï¼‰ |
| **æ—¶é—´å­—æ®µ** | `notification_sent_at` | `payment_deadline` |
| **çŠ¶æ€å­—æ®µ** | `status` (waiting/notified/expired/booked) | `status` (PENDING_PAYMENT/scheduled/cancelled) |
| **æ£€æŸ¥æ–¹å¼** | `notification_sent_at < NOW() - 15åˆ†é’Ÿ` | `payment_deadline < NOW()` |
| **å®šæ—¶ä»»åŠ¡** | `WaitlistExpirationTask` | `AddOnPaymentExpirationTask` |
| **è¶…æ—¶å¤„ç†** | çŠ¶æ€æ”¹ä¸º `expired` | çŠ¶æ€æ”¹ä¸º `CANCELLED` + é‡Šæ”¾å·æº |
| **è§¦å‘æ¡ä»¶** | å·æºé‡Šæ”¾ï¼Œé€šçŸ¥å€™è¡¥ | ç®¡ç†å‘˜æ‰¹å‡†ï¼Œè‡ªåŠ¨åˆ›å»ºé¢„çº¦ |

---

## âœ… ä¼˜åŠ¿

1. **ä¸éœ€è¦æ–°å»ºè¡¨** - å¤ç”¨ç°æœ‰è¡¨ç»“æ„
2. **å®ç°ç®€å•** - å‚è€ƒå€™è¡¥çš„æˆç†Ÿå®ç°
3. **æ˜“äºç»´æŠ¤** - é€»è¾‘æ¸…æ™°ï¼Œä»£ç å¤ç”¨åº¦é«˜
4. **æ€§èƒ½è‰¯å¥½** - å®šæ—¶ä»»åŠ¡è½»é‡çº§ï¼Œç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
5. **æ‰©å±•æ€§å¼º** - æ”¯ä»˜æœŸé™å¯é…ç½®ï¼Œçµæ´»è°ƒæ•´

---

## ğŸ”§ å®ç°æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“è°ƒæ•´ âœ…
- æ‰§è¡Œ `15_add_add_on_fields.sql`
- æ·»åŠ å¿…è¦çš„å­—æ®µå’Œç´¢å¼•

### ç¬¬äºŒæ­¥ï¼šå®ä½“ç±»è°ƒæ•´
- `Schedule` æ·»åŠ  `isAddOnSlot`, `reservedForPatientId`, `slotApplicationId`
- `Appointment` æ·»åŠ  `paymentDeadline`
- `SlotApplication` æ·»åŠ  `appointmentId`

### ç¬¬ä¸‰æ­¥ï¼šRepositoryå±‚
```java
// AppointmentRepository æ·»åŠ æ–¹æ³•
List<Appointment> findByAppointmentTypeAndStatusAndPaymentDeadlineBefore(
    AppointmentType type, 
    AppointmentStatus status, 
    LocalDateTime deadline
);
```

### ç¬¬å››æ­¥ï¼šServiceå±‚
- åˆ›å»º `AddOnSlotService`ï¼ˆå¤„ç†å®¡æ‰¹é€šè¿‡åçš„é€»è¾‘ï¼‰
- åˆ›å»º `AddOnPaymentService`ï¼ˆå¤„ç†æ”¯ä»˜é€»è¾‘ï¼‰

### ç¬¬äº”æ­¥ï¼šå®šæ—¶ä»»åŠ¡
- åˆ›å»º `AddOnPaymentExpirationTask`ï¼ˆå‚è€ƒ `WaitlistExpirationTask`ï¼‰

### ç¬¬å…­æ­¥ï¼šControllerå±‚
- å¢å¼º `SlotApplicationController` çš„å®¡æ‰¹æ¥å£
- åˆ›å»º `AddOnAppointmentController`ï¼ˆæ”¯ä»˜ç›¸å…³ï¼‰

### ç¬¬ä¸ƒæ­¥ï¼šå‰ç«¯å®ç°
- æ‚£è€…ç«¯ï¼šåŠ å·é€šçŸ¥é¡µé¢ + æ”¯ä»˜é¡µé¢
- ç®¡ç†å‘˜ç«¯ï¼šå®¡æ‰¹æµç¨‹ä¼˜åŒ–

---

## ğŸ’¡ å…³é”®æ³¨æ„äº‹é¡¹

1. **äº‹åŠ¡ç®¡ç†**ï¼šå®¡æ‰¹é€šè¿‡çš„æ•´ä¸ªæµç¨‹è¦åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­
2. **å¹¶å‘æ§åˆ¶**ï¼šè™šæ‹Ÿå·æºåˆ›å»ºè¦åŠ é”
3. **æ”¯ä»˜å¹‚ç­‰æ€§**ï¼šæ”¯ä»˜æ¥å£è¦é˜²æ­¢é‡å¤æ”¯ä»˜
4. **é€šçŸ¥å¯é æ€§**ï¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ç¡®ä¿é€šçŸ¥é€è¾¾
5. **æ•°æ®ä¸€è‡´æ€§**ï¼šå®šæ—¶ä»»åŠ¡è¦å¤„ç†å¥½è¾¹ç•Œæƒ…å†µ
6. **æ—¥å¿—è®°å½•**ï¼šå…³é”®æ­¥éª¤è¯¦ç»†è®°å½•ï¼Œä¾¿äºè¿½æº¯

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æ‰§è¡Œ `15_add_add_on_fields.sql` å®Œæˆæ•°æ®åº“è°ƒæ•´ï¼Œç„¶åå¼€å§‹å®ç°åç«¯é€»è¾‘ã€‚
