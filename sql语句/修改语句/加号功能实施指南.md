# åŠ å·åŠŸèƒ½å®žæ–½æŒ‡å—

## ðŸ“‹ ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“è¡¨ç»“æž„è°ƒæ•´ï¼ˆå½“å‰æ­¥éª¤ï¼‰

### æ‰§è¡Œå‰æ£€æŸ¥
```sql
-- 1. ç¡®è®¤ slot_application è¡¨å·²åˆ›å»º
SHOW TABLES LIKE 'slot_application';

-- 2. ç¡®è®¤ appointments è¡¨ç»“æž„
DESC appointments;

-- 3. ç¡®è®¤ schedules è¡¨ç»“æž„
DESC schedules;

-- 4. å¤‡ä»½æ•°æ®åº“ï¼ˆé‡è¦ï¼ï¼‰
mysqldump -u root -p hospital_system > backup_before_add_on_$(date +%Y%m%d_%H%M%S).sql
```

### æ‰§è¡ŒSQLè„šæœ¬
```bash
# åœ¨MySQLå‘½ä»¤è¡Œæˆ–å·¥å…·ä¸­æ‰§è¡Œ
mysql -u root -p hospital_system < 15_add_add_on_fields.sql
```

### æ‰§è¡ŒåŽéªŒè¯
```sql
-- 1. éªŒè¯ schedules è¡¨æ–°å¢žå­—æ®µ
DESC schedules;
-- åº”è¯¥çœ‹åˆ°ï¼š
-- is_add_on_slot
-- reserved_for_patient_id
-- slot_application_id

-- 2. éªŒè¯ appointments è¡¨æ–°å¢žå­—æ®µ
DESC appointments;
-- åº”è¯¥çœ‹åˆ°ï¼š
-- payment_deadline

-- 3. éªŒè¯ slot_application è¡¨æ–°å¢žå­—æ®µ
DESC slot_application;
-- åº”è¯¥çœ‹åˆ°ï¼š
-- appointment_id

-- 4. éªŒè¯ç´¢å¼•
SHOW INDEX FROM schedules WHERE Key_name LIKE '%reserved%' OR Key_name LIKE '%slot_application%';
SHOW INDEX FROM appointments WHERE Key_name LIKE '%payment_deadline%';

-- 5. éªŒè¯å¤–é”®çº¦æŸ
SELECT 
    CONSTRAINT_NAME,
    TABLE_NAME,
    COLUMN_NAME,
    REFERENCED_TABLE_NAME,
    REFERENCED_COLUMN_NAME
FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
WHERE TABLE_SCHEMA = 'hospital_system'
  AND (CONSTRAINT_NAME LIKE '%slot_application%' 
       OR CONSTRAINT_NAME LIKE '%reserved%');
```

---

## ðŸŽ¯ å®Œæˆæ ‡å¿—

å½“ä½ çœ‹åˆ°ä»¥ä¸‹ç»“æžœæ—¶ï¼Œç¬¬ä¸€æ­¥å®Œæˆï¼š

### schedules è¡¨
```
+---------------------------+------------+------+-----+---------+-------+
| Field                     | Type       | Null | Key | Default | Extra |
+---------------------------+------------+------+-----+---------+-------+
| ...                       | ...        | ...  | ... | ...     | ...   |
| is_add_on_slot            | tinyint(1) | YES  |     | 0       |       |
| reserved_for_patient_id   | bigint     | YES  | MUL | NULL    |       |
| slot_application_id       | int        | YES  | MUL | NULL    |       |
+---------------------------+------------+------+-----+---------+-------+
```

### appointments è¡¨
```
+-------------------+----------+------+-----+---------+-------+
| Field             | Type     | Null | Key | Default | Extra |
+-------------------+----------+------+-----+---------+-------+
| ...               | ...      | ...  | ... | ...     | ...   |
| payment_deadline  | datetime | YES  | MUL | NULL    |       |
+-------------------+----------+------+-----+---------+-------+
```

### slot_application è¡¨
```
+------------------+------+------+-----+---------+-------+
| Field            | Type | Null | Key | Default | Extra |
+------------------+------+------+-----+---------+-------+
| ...              | ...  | ...  | ... | ...     | ...   |
| appointment_id   | int  | YES  | MUL | NULL    |       |
+------------------+------+------+-----+---------+-------+
```

---

## ðŸ“Š æ•°æ®åº“ERå…³ç³»ï¼ˆæ›´æ–°åŽï¼‰

```
slot_application (åŠ å·ç”³è¯·)
    â†“ (å®¡æ‰¹é€šè¿‡åŽ)
    â”œâ”€â†’ schedules (è™šæ‹Ÿå·æº)
    â”‚   - is_add_on_slot = 1
    â”‚   - reserved_for_patient_id = æ‚£è€…ID
    â”‚   - slot_application_id = ç”³è¯·ID
    â”‚   - status = 'locked'
    â”‚
    â””â”€â†’ appointments (è‡ªåŠ¨é¢„çº¦)
        - appointment_type = 'ADD_ON'
        - is_add_on = 1
        - status = 'PENDING_PAYMENT'
        - payment_deadline = NOW() + 24å°æ—¶
        - schedule_id â†’ è™šæ‹Ÿå·æºID
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: å¤–é”®çº¦æŸåˆ›å»ºå¤±è´¥
**åŽŸå› **ï¼šslot_application è¡¨ä¸å­˜åœ¨æˆ–å­—æ®µç±»åž‹ä¸åŒ¹é…

**è§£å†³**ï¼š
```sql
-- å…ˆæ‰§è¡Œ 14_create_slot_application_table.sql
-- ç¡®è®¤è¡¨å­˜åœ¨åŽå†æ‰§è¡Œ 15_add_add_on_fields.sql
```

### Q2: å­—æ®µå·²å­˜åœ¨é”™è¯¯
**åŽŸå› **ï¼šè„šæœ¬å·²æ‰§è¡Œè¿‡

**è§£å†³**ï¼š
```sql
-- æ£€æŸ¥å­—æ®µæ˜¯å¦å·²å­˜åœ¨
SELECT COLUMN_NAME 
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_SCHEMA = 'hospital_system' 
  AND TABLE_NAME = 'schedules' 
  AND COLUMN_NAME IN ('is_add_on_slot', 'reserved_for_patient_id', 'slot_application_id');

-- å¦‚æžœå·²å­˜åœ¨ï¼Œè·³è¿‡æ­¤æ­¥éª¤
```

### Q3: ç´¢å¼•åˆ›å»ºå¤±è´¥
**åŽŸå› **ï¼šç´¢å¼•åç§°å†²çª

**è§£å†³**ï¼š
```sql
-- åˆ é™¤æ—§ç´¢å¼•
DROP INDEX idx_reserved_patient ON schedules;
DROP INDEX idx_slot_application ON schedules;
DROP INDEX idx_payment_deadline ON appointments;

-- é‡æ–°æ‰§è¡Œè„šæœ¬
```

---

## ðŸ”„ å›žæ»šæ–¹æ¡ˆï¼ˆå¦‚æžœéœ€è¦ï¼‰

```sql
-- å›žæ»š schedules è¡¨
ALTER TABLE `schedules` 
DROP FOREIGN KEY `fk_schedule_slot_application`,
DROP INDEX `idx_reserved_patient`,
DROP INDEX `idx_slot_application`,
DROP COLUMN `is_add_on_slot`,
DROP COLUMN `reserved_for_patient_id`,
DROP COLUMN `slot_application_id`;

-- å›žæ»š appointments è¡¨
ALTER TABLE `appointments` 
DROP INDEX `idx_payment_deadline`,
DROP COLUMN `payment_deadline`;

-- å›žæ»š slot_application è¡¨
ALTER TABLE `slot_application`
DROP FOREIGN KEY `fk_slot_application_appointment`,
DROP INDEX `idx_appointment`,
DROP COLUMN `appointment_id`;
```

---

## âœ… ä¸‹ä¸€æ­¥é¢„å‘Š

å®Œæˆæ•°æ®åº“è°ƒæ•´åŽï¼Œä¸‹ä¸€æ­¥æ˜¯ï¼š

### ç¬¬äºŒæ­¥ï¼šå®žä½“ç±»è°ƒæ•´
- ä¿®æ”¹ `Schedule.java`
- ä¿®æ”¹ `Appointment.java`
- ä¿®æ”¹ `SlotApplication.java`

### ç¬¬ä¸‰æ­¥ï¼šRepositoryå±‚
- æ·»åŠ æŸ¥è¯¢æ–¹æ³•åˆ° `AppointmentRepository`
- æ·»åŠ æŸ¥è¯¢æ–¹æ³•åˆ° `ScheduleRepository`

### ç¬¬å››æ­¥ï¼šServiceå±‚å®žçŽ°
- åˆ›å»º `AddOnSlotService`
- åˆ›å»º `AddOnPaymentService`

---

## ðŸ“ æ‰§è¡Œè®°å½•

è¯·åœ¨æ‰§è¡ŒåŽå¡«å†™ï¼š

- [ ] æ•°æ®åº“å¤‡ä»½å®Œæˆ
- [ ] SQLè„šæœ¬æ‰§è¡ŒæˆåŠŸ
- [ ] å­—æ®µéªŒè¯é€šè¿‡
- [ ] ç´¢å¼•éªŒè¯é€šè¿‡
- [ ] å¤–é”®çº¦æŸéªŒè¯é€šè¿‡
- [ ] æ‰§è¡Œæ—¶é—´ï¼š__________
- [ ] æ‰§è¡Œäººï¼š__________
- [ ] å¤‡æ³¨ï¼š__________

---

## ðŸŽ¯ å‡†å¤‡å¥½äº†å—ï¼Ÿ

å¦‚æžœä»¥ä¸Šæ£€æŸ¥éƒ½é€šè¿‡ï¼Œä½ å¯ä»¥å¼€å§‹æ‰§è¡Œ `15_add_add_on_fields.sql` äº†ï¼

æ‰§è¡Œå‘½ä»¤ï¼š
```bash
mysql -u root -p hospital_system < 15_add_add_on_fields.sql
```

æˆ–åœ¨MySQLå®¢æˆ·ç«¯ä¸­ï¼š
```sql
USE hospital_system;
SOURCE /path/to/15_add_add_on_fields.sql;
```
