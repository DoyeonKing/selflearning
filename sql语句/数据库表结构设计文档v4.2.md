# 校医院挂号系统表结构设计 (v4.2)

## 一、核心用户模型

### 1. patients (患者表)
| 字段名           | 数据类型     | 约束/描述                              |
|------------------|--------------|---------------------------------------|
| patient_id       | INT          | 主键 (PK), 自增 (AI)                  |
| identifier       | VARCHAR(100) | 唯一 (UNIQUE), 学号或工号             |
| patient_type     | ENUM('student','teacher','staff') | 患者类型                           |
| password_hash    | VARCHAR(255) | 哈希加盐后的密码                     |
| full_name        | VARCHAR(100) | 真实姓名                              |
| phone_number     | VARCHAR(20)  | 唯一 (UNIQUE), 存储E.164标准格式      |
| status           | ENUM('active','inactive','locked') | 账户状态, 默认'active' |
| created_at       | TIMESTAMP    | 账户创建时间, 默认当前时间            |
| updated_at       | TIMESTAMP    | 信息最后更新时间, 自动更新            |

### 2. doctors (医生表)
| 字段名           | 数据类型     | 约束/描述                              |
|------------------|--------------|---------------------------------------|
| doctor_id        | INT          | 主键 (PK), 自增 (AI)                  |
| department_id    | INT          | 外键 (FK) 关联 departments 表, 所属科室 |
| identifier       | VARCHAR(100) | 唯一 (UNIQUE), 医生的工号             |
| password_hash    | VARCHAR(255) | 哈希加盐后的密码                     |
| full_name        | VARCHAR(100) | 真实姓名                              |
| id_card_number   | VARCHAR(18)  | 唯一 (UNIQUE), 身份证号, 建议加密     |
| phone_number     | VARCHAR(20)  | 唯一 (UNIQUE), 存储E.164标准格式      |
| title            | VARCHAR(100) | 职称 (如："主治医师")                |
| specialty        | TEXT         | 擅长领域描述                          |
| bio              | TEXT         | 个人简介                              |
| photo_url        | VARCHAR(255) | 头像照片URL                           |
| status           | ENUM('active','inactive','locked') | 账户状态, 默认'active' |
| created_at       | TIMESTAMP    | 账户创建时间, 默认当前时间            |
| updated_at       | TIMESTAMP    | 信息最后更新时间, 自动更新            |

### 3. admins (管理员表)
| 字段名           | 数据类型     | 约束/描述                              |
|------------------|--------------|---------------------------------------|
| admin_id         | INT          | 主键 (PK), 自增 (AI)                  |
| username         | VARCHAR(100) | 唯一 (UNIQUE), 管理员登录用户名       |
| password_hash    | VARCHAR(255) | 哈希加盐后的密码                     |
| full_name        | VARCHAR(100) | 管理员真实姓名                        |
| status           | ENUM('active','inactive','locked') | 账户状态, 默认'active' |
| created_at       | TIMESTAMP    | 账户创建时间, 默认当前时间            |

## 二、组织架构与排班模型

### 4. parent_departments (父科室表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| parent_department_id| INT         | 主键 (PK), 自增 (AI)           |
| name                | VARCHAR(100)| 父科室名称 (如: 内科, 外科)   |
| description         | TEXT        | 科室职能描述                   |

### 5. departments (子科室表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| department_id       | INT         | 主键 (PK), 自增 (AI)           |
| parent_id           | INT         | 外键 (FK) 关联 parent_departments 表 |
| name                | VARCHAR(100)| 子科室名称 (如: 呼吸内科, 心血管内科) |
| description         | TEXT        | 科室职能描述                   |

### 6. time_slots (固定时间段表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| slot_id             | INT         | 主键 (PK), 自增 (AI)           |
| slot_name           | VARCHAR(100)| 时段名称 (如"上午 08:00-08:30") |
| start_time          | TIME        | 开始时间                       |
| end_time            | TIME        | 结束时间                       |

### 7. locations (诊室表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| location_id         | INT         | 主键 (PK), 自增 (AI)           |
| location_name       | VARCHAR(100)| 诊室名称 (如："门诊楼201室")   |
| department_id       | INT         | 外键 (FK) 关联 departments 表 |
| floor_level         | INT         | 楼层                           |
| building            | VARCHAR(50) | 楼栋 (如："门诊楼"、"外科楼")  |
| room_number         | VARCHAR(20) | 房间号 (如："201"、"302")      |
| capacity            | INT         | 容纳人数                       |
| map_node_id         | INT         | 外键 (FK) 关联 map_nodes 表   |

### 8. schedules (医生排班表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| schedule_id         | INT         | 主键 (PK), 自增 (AI)           |
| doctor_id           | INT         | 外键 (FK) 关联 doctors 表     |
| schedule_date       | DATE        | 出诊日期                       |
| slot_id             | INT         | 外键 (FK) 关联 time_slots 表  |
| location_id         | INT         | 外键 (FK) 关联 locations 表   |
| total_slots         | INT         | 总号源数                       |
| booked_slots        | INT         | 已预约数, 默认为0             |
| fee                 | DECIMAL(10, 2) | 挂号费用                     |
| status              | ENUM('available','full','cancelled') | 排班状态, 默认'available' |
| remarks             | TEXT        | 特别的排班要求或备注信息      |
| created_at          | TIMESTAMP   | 创建时间, 默认当前时间         |
| updated_at          | TIMESTAMP   | 更新时间, 自动更新             |

### 唯一约束:
- (doctor_id, schedule_date, slot_id)

## 三、核心业务与流程模型

### 9. patient_profiles (患者信息扩展表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| patient_id          | INT         | 主键 (PK), 外键 (FK) 关联 patients 表 |
| id_card_number      | VARCHAR(18) | 建议应用层加密存储, 身份证号     |
| allergies           | TEXT        | 建议应用层加密存储, 过敏史       |
| medical_history     | TEXT        | 建议应用层加密存储, 基础病史     |
| no_show_count       | INT         | 爽约次数, 默认为0               |
| blacklist_status    | ENUM('normal','blacklisted') | 黑名单状态, 默认'normal'  |

### 10. appointments (预约挂号表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| appointment_id      | INT         | 主键 (PK), 自增 (AI)           |
| patient_id          | INT         | 外键 (FK) 关联 patients 表     |
| schedule_id         | INT         | 外键 (FK) 关联 schedules 表    |
| appointment_number  | INT         | 就诊序号                       |
| status              | ENUM('scheduled','completed','cancelled','no_show') | 预约状态 |
| payment_status      | ENUM('unpaid','paid','refunded') | 支付状态 |
| payment_method      | VARCHAR(50) | 支付方式                       |
| transaction_id      | VARCHAR(255)| 支付流水号                     |
| check_in_time       | DATETIME    | 现场签到时间                   |
| created_at          | TIMESTAMP   | 预约生成时间, 默认当前时间     |

### 11. waitlist (候补表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| waitlist_id         | INT         | 主键 (PK), 自增 (AI)           |
| patient_id          | INT         | 外键 (FK) 关联 patients 表     |
| schedule_id         | INT         | 外键 (FK) 关联 schedules 表    |
| status              | ENUM('waiting','notified','expired','booked') | 候补状态 |
| notification_sent_at| DATETIME    | 系统发送通知的时间             |
| created_at          | TIMESTAMP   | 加入队列的时间, 默认当前时间  |

### 12. symptom_department_mapping (症状-科室映射表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| mapping_id          | INT         | 主键 (PK), 自增 (AI)           |
| symptom_keywords    | VARCHAR(255)| 症状关键词, 支持多个关键词      |
| department_id       | INT         | 外键 (FK) 关联 departments 表  |
| priority            | INT         | 推荐优先级, 默认1               |
| created_at          | TIMESTAMP   | 创建时间, 默认当前时间         |
| updated_at          | TIMESTAMP   | 更新时间, 自动更新             |

### 13. medical_guidelines (就医规范表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| guideline_id        | INT         | 主键 (PK), 自增 (AI)           |
| title               | VARCHAR(200)| 规范标题                       |
| content             | TEXT        | 规范内容                       |
| category            | VARCHAR(100)| 规范分类                       |
| status              | ENUM('active','inactive') | 状态 |
| created_by          | INT         | 外键 (FK) 关联 admins 表      |
| created_at          | TIMESTAMP   | 创建时间, 默认当前时间         |
| updated_at          | TIMESTAMP   | 更新时间, 自动更新             |

### 14. notifications (通知消息表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| notification_id     | BIGINT      | 主键 (PK), 自增 (AI)           |
| user_id             | INT         | 接收用户ID                     |
| user_type           | ENUM('patient','doctor','admin') | 用户类型 |
| type                | VARCHAR(50) | 通知类型 (appointment_reminder, cancellation, waitlist_available, schedule_change, system_notice等) |
| title               | VARCHAR(200)| 通知标题                       |
| content             | TEXT        | 通知内容                       |
| related_entity      | VARCHAR(50) | 相关实体类型 (如: appointment, schedule) |
| related_id          | INT         | 相关实体ID                     |
| status              | ENUM('unread','read','deleted') | 通知状态, 默认'unread' |
| priority            | ENUM('low','normal','high','urgent') | 优先级, 默认'normal' |
| sent_at             | TIMESTAMP   | 发送时间, 默认当前时间         |
| read_at             | DATETIME    | 阅读时间                       |

### 索引:
- (user_id, user_type): 查询用户通知
- status: 按状态筛选
- sent_at: 按时间排序

## 四、权限与管理模型 (RBAC)

### 15. roles (角色表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| role_id             | INT         | 主键 (PK), 自增 (AI)           |
| role_name           | VARCHAR(50) | 唯一 (UNIQUE), 角色名称        |
| description         | TEXT        | 角色职责描述                   |

### 16. permissions (权限表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| permission_id       | INT         | 主键 (PK), 自增 (AI)           |
| permission_name     | VARCHAR(100)| 唯一 (UNIQUE), 权限名称        |
| description         | TEXT        | 权限详细描述                   |

### 17. role_permissions (角色-权限映射表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| role_id             | INT         | 外键 (FK) 关联 roles 表        |
| permission_id       | INT         | 外键 (FK) 关联 permissions 表 |

### 18. admin_roles (管理员-角色映射表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| admin_id            | INT         | 外键 (FK) 关联 admins 表       |
| role_id             | INT         | 外键 (FK) 关联 roles 表        |

## 五、辅助与日志模型

### 19. leave_requests (调班/休假申请表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| request_id          | INT         | 主键 (PK), 自增 (AI)           |
| doctor_id           | INT         | 外键 (FK) 关联 doctors 表     |
| request_type        | ENUM('leave','schedule_change') | 申请类型 |
| start_time          | DATETIME    | 申请开始时间                   |
| end_time            | DATETIME    | 申请结束时间                   |
| reason              | TEXT        | 申请事由                       |
| status              | ENUM('pending','approved','rejected') | 审批状态 |
| approver_id         | INT         | 外键 (FK) 关联 admins 表      |
| approver_comments   | TEXT        | 审批人员的意见或备注          |
| created_at          | TIMESTAMP   | 申请创建时间, 默认当前时间     |
| updated_at          | TIMESTAMP   | 申请更新时间, 自动更新         |

### 20. audit_logs (审计日志表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| log_id              | BIGINT      | 主键 (PK), 自增 (AI)           |
| actor_id            | INT         | 操作者ID                       |
| actor_type          | ENUM('patient','doctor','admin') | 操作者类型 |
| action              | VARCHAR(255)| 操作行为描述                   |
| target_entity       | VARCHAR(100)| 被操作对象所在的表名           |
| target_id           | INT         | 被操作对象的ID                 |
| details             | TEXT        | 操作详细信息                   |
| created_at          | TIMESTAMP   | 操作发生时间, 默认当前时间     |

## 六、地图导航模型

### 21. map_nodes (地图节点表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| node_id             | INT         | 主键 (PK), 自增 (AI)           |
| node_name           | VARCHAR(100)| 节点名称 (如："门诊大厅"、"药房") |
| node_type           | ENUM('room','hallway','elevator','stairs','entrance') | 节点类型 |
| coordinates_x       | DECIMAL(10, 2) | X坐标                        |
| coordinates_y       | DECIMAL(10, 2) | Y坐标                        |
| floor_level         | INT         | 楼层                           |
| description         | TEXT        | 节点描述                       |
| is_accessible       | BOOLEAN     | 是否无障碍通行                 |

### 22. map_edges (地图路径表)
| 字段名              | 数据类型    | 约束/描述                       |
|---------------------|-------------|--------------------------------|
| edge_id             | INT         | 主键 (PK), 自增 (AI)           |
| start_node_id       | INT         | 外键 (FK) 关联 map_nodes 表   |
| end_node_id         | INT         | 外键 (FK) 关联 map_nodes 表   |
| distance            | DECIMAL(10, 2) | 距离 (米)                     |
| walk_time           | INT         | 步行时间 (秒)                 |
| is_bidirectional    | BOOLEAN     | 是否双向通行                   |
| accessibility_info  | TEXT        | 无障碍设施信息                 |

---

## 主要更新说明 (v4.2):
1. doctors表：新增 id_card_number 字段，用于存储医生的身份证号
2. **新增 locations 表**：诊室信息独立管理，包含楼栋、楼层、房间号、容纳人数等信息
3. schedules表：将 location 字段从 VARCHAR(200) 改为 location_id (INT)，外键关联 locations 表
4. 新增 symptom_department_mapping 表：支持基于症状关键词的AI智能挂号推荐
5. 新增 medical_guidelines 表：用于管理校医院的各项就医规范和流程
6. **新增 notifications 表**：通知消息系统，支持预约提醒、取消通知、候补通知、系统公告等多种通知类型
7. 组织架构调整：使用 parent_departments 和 departments 两级科室结构
8. 新增地图导航模型：包含 map_nodes 和 map_edges 表，支持院内导航功能
9. **诊室与地图集成**：locations 表通过 map_node_id 关联到 map_nodes 表，实现诊室定位功能

## 费用管理说明：
- schedules表的 fee 字段用于设置挂号费用
- 管理员可以根据医生、科室等因素灵活设置不同的挂号费
- 默认挂号费为 5.00 元
