# 叫号规则实现状态检查

## 用户提出的规则清单

### 1. ✅ 预约优先
**规则**：同一时段内，已预约患者永远排在现场挂号患者之前

**实现状态**：✅ **已实现**
- 位置：`AppointmentService.getCallQueue()` 第867-877行
- 逻辑：在排序时，预约挂号（`!a1WalkIn`）优先于现场挂号（`a1WalkIn`）

### 2. ✅ 先签到先就诊
**规则**：
- 提前签到（时段开始前）：按挂号序号排序
- 时段内签到：按签到时间升序生成"实时候诊序号"

**实现状态**：✅ **已实现**
- 位置：`AppointmentService.assignRealTimeQueueNumber()` 第1130-1200行
- 逻辑：
  - 提前签到：按挂号序号排序（第1145-1150行）
  - 时段内签到：按签到时间排序（第1152-1156行）
  - 合并时，提前签到的在前，时段内签到的在后（第1159行）

### 3. ❌ 签到时间窗口
**规则**：时段开始前15分钟至时段结束前10分钟

**实现状态**：❌ **未实现**
- 当前实现：软关门5分钟（时段结束后5分钟）
- 位置：`AppointmentService.checkIn()` 第683-720行
- 问题：当前逻辑是时段结束后5分钟内仍可签到，但用户要求的是：
  - 时段开始前15分钟才能开始签到
  - 时段结束前10分钟之后算迟到
  - 时段结束后不能签到

### 4. ✅ 迟到降档
**规则**：
- 错过本时段：移到"当前正在叫号时段"的队尾
- 跨上午/下午场：直接作废，须重新挂当场号

**实现状态**：✅ **已实现**
- 位置：`AppointmentService.checkIn()` 第688-712行
- 逻辑：
  - 跨场判断：`isCrossSession()` 方法（第1106-1130行）
  - 跨场：直接作废预约（第695-706行）
  - 未跨场但迟到：标记为迟到，排在队尾（第708-711行）

### 5. ✅ 过号重排
**规则**：听到叫号未进诊室，需到自助机"再次扫码"，系统把你放在"当前时段最后一位"

**实现状态**：✅ **已实现**
- 位置：`AppointmentService.recheckInAfterMissedCall()` 第1044-1100行
- 逻辑：
  - 清除叫号时间（第1067行）
  - 记录重新签到时间（第1070行）
  - 分配最大实时候诊序号+1，排在最后（第1080-1087行）

### 6. ✅ 当日复诊号插入
**规则**：每两位正常挂号患者之后插入一个复诊号

**实现状态**：✅ **已实现**
- 位置：`AppointmentService.getCallQueue()` 第960-973行
- 逻辑：每3个位置插入一个复诊号（即每2个正常患者后1个复诊号）

### 7. ✅ 加号排在最后
**规则**：加号排在所有正常号末尾

**实现状态**：✅ **已实现**
- 位置：`AppointmentService.getCallQueue()` 第981-982行
- 逻辑：加号排在队列最后

## 总结

### ✅ 已实现的规则（6项）
1. 预约优先
2. 先签到先就诊（提前签到按序号，时段内按时间）
3. 迟到降档（跨场作废，未跨场排末尾）
4. 过号重排（排当前时段最后一位）
5. 当日复诊号插入（每两位正常患者后一个）
6. 加号排在最后

### ❌ 未实现的规则（1项）
1. **签到时间窗口**：需要从"软关门5分钟"改为"时段开始前15分钟至结束前10分钟"

## 需要修改的地方

**文件**：`AppointmentService.checkIn()` 方法（第677-745行）

**当前逻辑**：
- 软关门：时段结束后5分钟
- 判断：`now.isAfter(softCloseTime)` 才算迟到

**需要改为**：
- 签到开始：时段开始前15分钟
- 签到截止：时段结束前10分钟
- 迟到判断：超过签到截止时间但未到时段结束 = 迟到，排末尾
- 时段结束：不能签到，需改约或退号


