@startuml åŒ»ç”Ÿè¯·å‡æµç¨‹æ—¶åºå›¾

title åœºæ™¯å››ï¼šåŒ»ç”Ÿè¯·å‡ä¸æ’ç­è‡ªåŠ¨å–æ¶ˆ - æ—¶åºå›¾

actor åŒ»ç”Ÿ as Doctor
actor ç®¡ç†å‘˜ as Admin
participant "å‰ç«¯ç•Œé¢" as Frontend
participant "åç«¯API" as Backend
participant "æ¶ˆæ¯é€šçŸ¥æœåŠ¡" as NotificationService
database "leave_requestsè¡¨" as LeaveDB
database "schedulesè¡¨" as SchedulesDB
database "appointmentsè¡¨" as AppointmentsDB
database "patientsè¡¨" as PatientsDB

== åŒ»ç”Ÿæäº¤è¯·å‡ç”³è¯· ==
Doctor -> Frontend : æ‰“å¼€è¯·å‡ç”³è¯·é¡µé¢
activate Frontend
Frontend --> Doctor : æ˜¾ç¤ºè¯·å‡ç”³è¯·è¡¨å•
deactivate Frontend

Doctor -> Frontend : å¡«å†™è¯·å‡ä¿¡æ¯\nå¼€å§‹æ—¥æœŸ: 2025-11-15\nç»“æŸæ—¥æœŸ: 2025-11-17\nè¯·å‡ç±»å‹: ç—…å‡\nè¯·å‡åŸå› : èº«ä½“ä¸é€‚
Doctor -> Frontend : ç‚¹å‡»"æäº¤ç”³è¯·"

Frontend -> Backend : POST /api/leave-requests/create\n{\n  doctor_id: 5,\n  start_date: "2025-11-15",\n  end_date: "2025-11-17",\n  leave_type: "sick_leave",\n  reason: "èº«ä½“ä¸é€‚"\n}
activate Frontend
activate Backend

Backend -> Backend : éªŒè¯è¯·å‡æ—¥æœŸæœ‰æ•ˆæ€§

Backend -> LeaveDB : INSERT INTO leave_requests\n(doctor_id, start_date, end_date,\nleave_type, reason, status,\ncreated_at)\nVALUES (5, '2025-11-15', '2025-11-17',\n'sick_leave', 'èº«ä½“ä¸é€‚', 'pending',\nNOW())
activate LeaveDB
LeaveDB --> Backend : æ’å…¥æˆåŠŸ\nleave_id=2001
deactivate LeaveDB

Backend -> NotificationService : å‘é€é€šçŸ¥ç»™ç®¡ç†å‘˜\n"åŒ»ç”Ÿå¼ ä¸‰æäº¤äº†è¯·å‡ç”³è¯·"
activate NotificationService
NotificationService --> Backend : é€šçŸ¥å·²å‘é€
deactivate NotificationService

Backend --> Frontend : è¿”å›æˆåŠŸ\n{\n  success: true,\n  leave_id: 2001,\n  message: "è¯·å‡ç”³è¯·å·²æäº¤ï¼Œç­‰å¾…å®¡æ‰¹"\n}
deactivate Backend

Frontend --> Doctor : æ˜¾ç¤ºæäº¤æˆåŠŸ\nç”³è¯·çŠ¶æ€ï¼šå¾…å®¡æ‰¹
deactivate Frontend

== ç®¡ç†å‘˜å®¡æ‰¹è¯·å‡ ==
Admin -> Frontend : æ‰“å¼€å¾…å®¡æ‰¹åˆ—è¡¨
activate Frontend

Frontend -> Backend : GET /api/leave-requests/pending
activate Backend
Backend -> LeaveDB : SELECT * FROM leave_requests\nWHERE status='pending'\nORDER BY created_at DESC
activate LeaveDB
LeaveDB --> Backend : è¿”å›å¾…å®¡æ‰¹åˆ—è¡¨
deactivate LeaveDB
Backend --> Frontend : è¿”å›è¯·å‡ç”³è¯·åˆ—è¡¨
deactivate Backend

Frontend --> Admin : æ˜¾ç¤ºå¾…å®¡æ‰¹ç”³è¯·\nåŒ…å«åŒ»ç”Ÿä¿¡æ¯ã€è¯·å‡æ—¶é—´ã€åŸå› ç­‰
deactivate Frontend

Admin -> Frontend : é€‰æ‹©ç”³è¯·(leave_id=2001)
Admin -> Frontend : ç‚¹å‡»"æ‰¹å‡†"æŒ‰é’®

== æ£€æŸ¥å—å½±å“çš„æ’ç­ ==
Frontend -> Backend : POST /api/leave-requests/approve\n{\n  leave_id: 2001,\n  approved_by: 1\n}
activate Frontend
activate Backend

Backend -> SchedulesDB : æŸ¥æ‰¾å†²çªçš„æ’ç­\nSELECT * FROM schedules\nWHERE doctor_id = 5\n  AND schedule_date BETWEEN '2025-11-15' AND '2025-11-17'\n  AND status = 'available'
activate SchedulesDB
SchedulesDB --> Backend : è¿”å›å†²çªæ’ç­åˆ—è¡¨\n[\n  {schedule_id: 1001, date: '2025-11-15', ...},\n  {schedule_id: 1002, date: '2025-11-16', ...},\n  {schedule_id: 1003, date: '2025-11-17', ...}\n]
deactivate SchedulesDB

alt å­˜åœ¨å†²çªçš„æ’ç­
    Backend -> Backend : åˆå§‹åŒ–å—å½±å“æ‚£è€…åˆ—è¡¨
    
    loop éå†æ¯ä¸ªå†²çªæ’ç­
        Backend -> AppointmentsDB : æŸ¥è¯¢è¯¥æ’ç­çš„é¢„çº¦è®°å½•\nSELECT * FROM appointments\nWHERE schedule_id = 1001\n  AND status IN ('confirmed', 'paid')
        activate AppointmentsDB
        AppointmentsDB --> Backend : è¿”å›é¢„çº¦è®°å½•
        deactivate AppointmentsDB
        
        alt è¯¥æ’ç­æœ‰æ‚£è€…é¢„çº¦
            Backend -> AppointmentsDB : æ›´æ–°é¢„çº¦çŠ¶æ€\nUPDATE appointments\nSET status = 'cancelled_by_doctor',\n    refund_status = 'pending'\nWHERE schedule_id = 1001
            activate AppointmentsDB
            AppointmentsDB --> Backend : æ›´æ–°æˆåŠŸ
            deactivate AppointmentsDB
            
            Backend -> PatientsDB : è·å–æ‚£è€…è”ç³»æ–¹å¼
            activate PatientsDB
            PatientsDB --> Backend : è¿”å›æ‚£è€…ä¿¡æ¯
            deactivate PatientsDB
            
            Backend -> NotificationService : å‘é€çŸ­ä¿¡/é€šçŸ¥ç»™æ‚£è€…\n"æ‚¨é¢„çº¦çš„å¼ åŒ»ç”Ÿé—¨è¯Šå·²å–æ¶ˆ\nåŸå› ï¼šåŒ»ç”Ÿè¯·å‡\næŒ‚å·è´¹å°†åŸè·¯é€€å›"
            activate NotificationService
            NotificationService --> Backend : é€šçŸ¥å·²å‘é€
            deactivate NotificationService
            
            Backend -> Backend : è®°å½•éœ€è¦é€€æ¬¾çš„é¢„çº¦
        end
        
        Backend -> SchedulesDB : å–æ¶ˆæ’ç­\nUPDATE schedules\nSET status = 'cancelled',\n    cancellation_reason = 'doctor_leave',\n    cancelled_at = NOW()\nWHERE schedule_id = 1001
        activate SchedulesDB
        SchedulesDB --> Backend : æ›´æ–°æˆåŠŸ
        deactivate SchedulesDB
    end
end

== æ‰¹å‡†è¯·å‡ç”³è¯· ==
Backend -> LeaveDB : æ›´æ–°è¯·å‡çŠ¶æ€\nUPDATE leave_requests\nSET status = 'approved',\n    approved_by = 1,\n    approved_at = NOW()\nWHERE leave_id = 2001
activate LeaveDB
LeaveDB --> Backend : æ›´æ–°æˆåŠŸ
deactivate LeaveDB

Backend -> NotificationService : å‘é€é€šçŸ¥ç»™åŒ»ç”Ÿ\n"æ‚¨çš„è¯·å‡ç”³è¯·å·²æ‰¹å‡†"
activate NotificationService
NotificationService --> Backend : é€šçŸ¥å·²å‘é€
deactivate NotificationService

Backend -> Backend : è®°å½•æ“ä½œæ—¥å¿—\nåŒ…æ‹¬ï¼š\n- æ‰¹å‡†çš„è¯·å‡ç”³è¯·\n- å–æ¶ˆçš„æ’ç­æ•°é‡\n- å—å½±å“çš„æ‚£è€…æ•°é‡\n- é€€æ¬¾é‡‘é¢ç»Ÿè®¡

Backend --> Frontend : è¿”å›å¤„ç†ç»“æœ\n{\n  success: true,\n  message: "è¯·å‡å·²æ‰¹å‡†",\n  affected_schedules: 3,\n  affected_patients: 15,\n  refund_amount: 375.00\n}
deactivate Backend

Frontend --> Admin : æ˜¾ç¤ºå¤„ç†ç»“æœ\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ âœ… è¯·å‡ç”³è¯·å·²æ‰¹å‡†        â”‚\nâ”‚                        â”‚\nâ”‚ ğŸ“… å–æ¶ˆæ’ç­: 3ä¸ª        â”‚\nâ”‚ ğŸ‘¥ å—å½±å“æ‚£è€…: 15äºº     â”‚\nâ”‚ ğŸ’° é€€æ¬¾é‡‘é¢: Â¥375.00   â”‚\nâ”‚                        â”‚\nâ”‚ ç³»ç»Ÿå·²è‡ªåŠ¨:             â”‚\nâ”‚ - å–æ¶ˆç›¸å…³æ’ç­          â”‚\nâ”‚ - é€šçŸ¥å—å½±å“æ‚£è€…        â”‚\nâ”‚ - æ ‡è®°é€€æ¬¾å¾…å¤„ç†        â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
deactivate Frontend

== åŒ»ç”Ÿæ”¶åˆ°å®¡æ‰¹é€šçŸ¥ ==
Doctor -> Frontend : æŸ¥çœ‹è¯·å‡ç”³è¯·çŠ¶æ€
activate Frontend
Frontend -> Backend : GET /api/leave-requests/my-requests
activate Backend
Backend -> LeaveDB : SELECT * FROM leave_requests\nWHERE doctor_id = 5\nORDER BY created_at DESC
activate LeaveDB
LeaveDB --> Backend : è¿”å›åŒ»ç”Ÿçš„è¯·å‡è®°å½•
deactivate LeaveDB
Backend --> Frontend : è¿”å›è¯·å‡åˆ—è¡¨
deactivate Backend
Frontend --> Doctor : æ˜¾ç¤ºè¯·å‡çŠ¶æ€ï¼šå·²æ‰¹å‡†\nè¯·å‡æ—¶é—´ï¼š2025-11-15 è‡³ 2025-11-17
deactivate Frontend

== æ‹’ç»è¯·å‡çš„åˆ†æ”¯æµç¨‹ ==
note over Admin, Backend
    å¦‚æœç®¡ç†å‘˜é€‰æ‹©æ‹’ç»è¯·å‡ï¼š
    1. æ›´æ–°leave_requestsè¡¨çŠ¶æ€ä¸º'rejected'
    2. è®°å½•æ‹’ç»åŸå› 
    3. ä¸æ‰§è¡Œæ’ç­å–æ¶ˆæ“ä½œ
    4. é€šçŸ¥åŒ»ç”Ÿè¯·å‡è¢«æ‹’ç»
end note

@enduml



