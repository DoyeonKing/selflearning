@startuml æ’ç­ä¿®æ”¹ä¸å–æ¶ˆæ—¶åºå›¾

title åœºæ™¯äº”ï¼šæ’ç­ä¿®æ”¹ä¸å–æ¶ˆ - æ—¶åºå›¾

actor ç®¡ç†å‘˜ as Admin
participant "å‰ç«¯ç•Œé¢" as Frontend
participant "åç«¯API" as Backend
participant "æ¶ˆæ¯é€šçŸ¥æœåŠ¡" as NotificationService
database "schedulesè¡¨" as SchedulesDB
database "appointmentsè¡¨" as AppointmentsDB
database "patientsè¡¨" as PatientsDB
database "locationsè¡¨" as LocationsDB

== æŸ¥çœ‹æ’ç­åˆ—è¡¨ ==
Admin -> Frontend : æ‰“å¼€æ’ç­ç®¡ç†é¡µé¢
activate Frontend

Frontend -> Backend : GET /api/schedules/list\n?date=2025-11-10\n&department_id=5
activate Backend
Backend -> SchedulesDB : SELECT * FROM schedules\nWHERE schedule_date='2025-11-10'\nAND status='available'
activate SchedulesDB
SchedulesDB --> Backend : è¿”å›æ’ç­åˆ—è¡¨
deactivate SchedulesDB
Backend --> Frontend : è¿”å›æ’ç­æ•°æ®
deactivate Backend

Frontend --> Admin : æ˜¾ç¤ºæ’ç­åˆ—è¡¨\n(åŒ»ç”Ÿ/æ—¶é—´/åœ°ç‚¹/å·æºç­‰)
deactivate Frontend

== ä¿®æ”¹æ’ç­æµç¨‹ ==
Admin -> Frontend : é€‰æ‹©è¦ä¿®æ”¹çš„æ’ç­\n(schedule_id=1001)
Admin -> Frontend : ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®

Frontend -> Backend : GET /api/schedules/1001/detail
activate Frontend
activate Backend
Backend -> SchedulesDB : SELECT * FROM schedules\nWHERE schedule_id=1001
activate SchedulesDB
SchedulesDB --> Backend : è¿”å›æ’ç­è¯¦æƒ…
deactivate SchedulesDB
Backend --> Frontend : è¿”å›å®Œæ•´æ’ç­ä¿¡æ¯
deactivate Backend

Frontend --> Admin : æ˜¾ç¤ºç¼–è¾‘è¡¨å•\nå½“å‰å€¼ï¼šåœ°ç‚¹=é—¨è¯Šæ¥¼-301, å·æº=10
deactivate Frontend

Admin -> Frontend : ä¿®æ”¹ä¿¡æ¯\nåœ°ç‚¹æ”¹ä¸ºï¼šé—¨è¯Šæ¥¼-305(ID=15)\nå·æºæ”¹ä¸ºï¼š12
Admin -> Frontend : ç‚¹å‡»"ä¿å­˜ä¿®æ”¹"

Frontend -> Backend : PUT /api/schedules/1001/update\n{\n  location_id: 15,\n  total_slots: 12\n}
activate Frontend
activate Backend

== éªŒè¯ä¿®æ”¹çš„åˆç†æ€§ ==
Backend -> Backend : éªŒè¯æ–°åœ°ç‚¹æ˜¯å¦å¯ç”¨

Backend -> LocationsDB : SELECT * FROM locations\nWHERE location_id=15\nAND status='available'
activate LocationsDB
LocationsDB --> Backend : è¿”å›åœ°ç‚¹ä¿¡æ¯
deactivate LocationsDB

alt æ–°åœ°ç‚¹ä¸å¯ç”¨
    Backend --> Frontend : è¿”å›é”™è¯¯\n{error: "æ‰€é€‰åœ°ç‚¹ä¸å¯ç”¨"}
    Frontend --> Admin : æ˜¾ç¤ºé”™è¯¯æç¤º
    deactivate Backend
    deactivate Frontend
else æ–°åœ°ç‚¹å¯ç”¨
    Backend -> AppointmentsDB : æ£€æŸ¥å·²é¢„çº¦æ•°é‡\nSELECT COUNT(*) as booked\nFROM appointments\nWHERE schedule_id=1001\nAND status IN ('confirmed', 'paid')
    activate AppointmentsDB
    AppointmentsDB --> Backend : è¿”å›å·²é¢„çº¦æ•°: 8
    deactivate AppointmentsDB
    
    alt æ–°å·æºæ•° < å·²é¢„çº¦æ•°
        Backend --> Frontend : è¿”å›é”™è¯¯\n{error: "æ–°å·æºæ•°(12)ä¸èƒ½å°äºå·²é¢„çº¦æ•°(8)"}
        Frontend --> Admin : æ˜¾ç¤ºé”™è¯¯æç¤º\n"å·²æœ‰8ä½æ‚£è€…é¢„çº¦ï¼Œå·æºä¸èƒ½å°‘äº8"
        deactivate Backend
        deactivate Frontend
    else æ–°å·æºæ•° >= å·²é¢„çº¦æ•°
        == æ‰§è¡Œæ›´æ–°æ“ä½œ ==
        Backend -> SchedulesDB : UPDATE schedules\nSET location_id = 15,\n    total_slots = 12,\n    updated_at = NOW()\nWHERE schedule_id = 1001
        activate SchedulesDB
        SchedulesDB --> Backend : æ›´æ–°æˆåŠŸ
        deactivate SchedulesDB
        
        == é€šçŸ¥å·²é¢„çº¦æ‚£è€… ==
        Backend -> AppointmentsDB : è·å–å·²é¢„çº¦æ‚£è€…
        activate AppointmentsDB
        AppointmentsDB --> Backend : è¿”å›æ‚£è€…åˆ—è¡¨
        deactivate AppointmentsDB
        
        Backend -> NotificationService : å‘é€é€šçŸ¥ç»™æ‚£è€…\n"æ‚¨é¢„çº¦çš„æ’ç­åœ°ç‚¹å·²å˜æ›´\næ–°åœ°ç‚¹ï¼šé—¨è¯Šæ¥¼-305è¯Šå®¤"
        activate NotificationService
        NotificationService --> Backend : é€šçŸ¥å·²å‘é€
        deactivate NotificationService
        
        Backend -> Backend : è®°å½•ä¿®æ”¹æ—¥å¿—
        
        Backend --> Frontend : è¿”å›æˆåŠŸ\n{\n  success: true,\n  message: "æ’ç­ä¿®æ”¹æˆåŠŸ",\n  notified_patients: 8\n}
        deactivate Backend
        
        Frontend --> Admin : æ˜¾ç¤ºæˆåŠŸæç¤º\n"æ’ç­å·²ä¿®æ”¹ï¼Œå·²é€šçŸ¥8ä½æ‚£è€…"
        deactivate Frontend
    end
end

== å–æ¶ˆæ’ç­æµç¨‹ ==
Admin -> Frontend : é€‰æ‹©è¦å–æ¶ˆçš„æ’ç­\n(schedule_id=1002)
Admin -> Frontend : ç‚¹å‡»"å–æ¶ˆæ’ç­"æŒ‰é’®

Frontend --> Admin : æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†\n"ç¡®å®šè¦å–æ¶ˆè¯¥æ’ç­å—ï¼Ÿ"
deactivate Frontend

Admin -> Frontend : ç¡®è®¤å–æ¶ˆ

Frontend -> Backend : POST /api/schedules/1002/cancel
activate Frontend
activate Backend

== æ£€æŸ¥æ˜¯å¦æœ‰æ‚£è€…é¢„çº¦ ==
Backend -> AppointmentsDB : SELECT * FROM appointments\nWHERE schedule_id=1002\nAND status IN ('confirmed', 'paid')
activate AppointmentsDB
AppointmentsDB --> Backend : è¿”å›é¢„çº¦è®°å½•åˆ—è¡¨
deactivate AppointmentsDB

alt æœ‰æ‚£è€…é¢„çº¦
    Backend -> Backend : è®¡ç®—éœ€é€€æ¬¾æ€»é¢
    
    loop éå†æ¯ä¸ªé¢„çº¦
        Backend -> AppointmentsDB : æ›´æ–°é¢„çº¦çŠ¶æ€\nUPDATE appointments\nSET status = 'cancelled_by_admin',\n    refund_status = 'pending',\n    cancelled_at = NOW()\nWHERE appointment_id = [é¢„çº¦ID]
        activate AppointmentsDB
        AppointmentsDB --> Backend : æ›´æ–°æˆåŠŸ
        deactivate AppointmentsDB
        
        Backend -> PatientsDB : è·å–æ‚£è€…ä¿¡æ¯
        activate PatientsDB
        PatientsDB --> Backend : è¿”å›æ‚£è€…è”ç³»æ–¹å¼
        deactivate PatientsDB
        
        Backend -> NotificationService : å‘é€é€€æ¬¾é€šçŸ¥\n"æ‚¨é¢„çº¦çš„é—¨è¯Šå·²å–æ¶ˆ\næŒ‚å·è´¹Â¥25.00å°†åœ¨3-5ä¸ªå·¥ä½œæ—¥é€€å›"
        activate NotificationService
        NotificationService --> Backend : é€šçŸ¥å·²å‘é€
        deactivate NotificationService
    end
    
    Backend -> SchedulesDB : æ›´æ–°æ’ç­çŠ¶æ€\nUPDATE schedules\nSET status = 'cancelled',\n    cancellation_reason = 'admin_cancelled',\n    cancelled_at = NOW(),\n    updated_at = NOW()\nWHERE schedule_id = 1002
    activate SchedulesDB
    SchedulesDB --> Backend : æ›´æ–°æˆåŠŸ
    deactivate SchedulesDB
    
    Backend -> Backend : è®°å½•å–æ¶ˆæ—¥å¿—\nåŒ…æ‹¬ï¼š\n- å–æ¶ˆçš„æ’ç­ID\n- å—å½±å“çš„æ‚£è€…æ•°\n- é€€æ¬¾æ€»é¢\n- æ“ä½œç®¡ç†å‘˜
    
    Backend --> Frontend : è¿”å›æˆåŠŸ\n{\n  success: true,\n  message: "æ’ç­å·²å–æ¶ˆ",\n  affected_patients: 5,\n  refund_amount: 125.00,\n  warnings: [\n    "å·²é€šçŸ¥5ä½æ‚£è€…",\n    "é€€æ¬¾é‡‘é¢Â¥125.00å¾…å¤„ç†"\n  ]\n}
    deactivate Backend
    
    Frontend --> Admin : æ˜¾ç¤ºå–æ¶ˆç»“æœ\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ âœ… æ’ç­å·²å–æ¶ˆ           â”‚\nâ”‚                        â”‚\nâ”‚ ğŸ“‹ å—å½±å“æ‚£è€…: 5äºº      â”‚\nâ”‚ ğŸ’° é€€æ¬¾é‡‘é¢: Â¥125.00   â”‚\nâ”‚                        â”‚\nâ”‚ âš ï¸ æ³¨æ„äº‹é¡¹:           â”‚\nâ”‚ - å·²é€šçŸ¥æ‰€æœ‰æ‚£è€…       â”‚\nâ”‚ - è¯·å¤„ç†é€€æ¬¾äº‹å®œ       â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    deactivate Frontend
    
else æ— æ‚£è€…é¢„çº¦
    Backend -> SchedulesDB : ç›´æ¥æ›´æ–°æ’ç­çŠ¶æ€\nUPDATE schedules\nSET status = 'cancelled',\n    cancellation_reason = 'admin_cancelled',\n    cancelled_at = NOW()\nWHERE schedule_id = 1002
    activate SchedulesDB
    SchedulesDB --> Backend : æ›´æ–°æˆåŠŸ
    deactivate SchedulesDB
    
    Backend --> Frontend : è¿”å›æˆåŠŸ\n{\n  success: true,\n  message: "æ’ç­å·²å–æ¶ˆï¼ˆæ— æ‚£è€…é¢„çº¦ï¼‰"\n}
    deactivate Backend
    
    Frontend --> Admin : æ˜¾ç¤ºæˆåŠŸæç¤º\n"æ’ç­å·²å–æ¶ˆ"
    deactivate Frontend
end

== è§¦å‘å†²çªé‡æ–°æ£€æµ‹ ==
note over Frontend, Backend
    æ’ç­ä¿®æ”¹æˆ–å–æ¶ˆåï¼Œ
    ç³»ç»Ÿè‡ªåŠ¨é‡æ–°æ£€æµ‹æ‰€æœ‰æ’ç­å†²çªï¼Œ
    æ›´æ–°é«˜äº®æ˜¾ç¤ºçŠ¶æ€
end note

Frontend -> Backend : POST /api/schedules/detect-conflicts
activate Frontend
activate Backend
Backend -> SchedulesDB : æ‰§è¡Œå†²çªæ£€æµ‹
activate SchedulesDB
SchedulesDB --> Backend : è¿”å›å†²çªæ•°æ®
deactivate SchedulesDB
Backend --> Frontend : è¿”å›æ›´æ–°åçš„å†²çªä¿¡æ¯
deactivate Backend
Frontend --> Admin : åˆ·æ–°æ’ç­åˆ—è¡¨\næ›´æ–°å†²çªé«˜äº®
deactivate Frontend

@enduml



