# åŒ»é™¢æ’ç­ç³»ç»Ÿ - å¿«é€Ÿå‚è€ƒæŒ‡å—

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥

### æ’ç­ä¸‰è¦ç´ 
```
æ’ç­ = åŒ»ç”Ÿ + æ—¶é—´ + åœ°ç‚¹
```

### æ•°æ®è¡¨å…³ç³»é€ŸæŸ¥
```
schedules (æ’ç­æ ¸å¿ƒè¡¨)
    â”œâ”€â”€ doctor_id â†’ doctors (åŒ»ç”Ÿè¡¨)
    â”‚       â””â”€â”€ department_id â†’ departments (ç§‘å®¤è¡¨)
    â”‚               â””â”€â”€ parent_id â†’ parent_departments (ä¸€çº§ç§‘å®¤è¡¨)
    â”œâ”€â”€ slot_id â†’ time_slots (æ—¶é—´æ®µè¡¨)
    â””â”€â”€ location_id â†’ locations (åœ°ç‚¹è¡¨)
```

---

## ğŸ“‹ åœºæ™¯é€ŸæŸ¥è¡¨

| åœºæ™¯ | ä¸»è¦è¡¨æ“ä½œ | å‚è€ƒå›¾è¡¨ |
|------|-----------|---------|
| åˆ›å»ºå•ä¸ªæ’ç­ | INSERT schedules | æ—¶åºå›¾3 |
| æ‰¹é‡å¯¼å…¥æ’ç­ | æ‰¹é‡ INSERT schedules | æ—¶åºå›¾4 |
| æ‚£è€…æŸ¥çœ‹æ’ç­ | SELECT (6è¡¨JOIN) | æ—¶åºå›¾5 |
| åŒ»ç”Ÿè¯·å‡ | INSERT leave_requests<br>UPDATE schedules (çŠ¶æ€) | æ—¶åºå›¾6 |
| ä¿®æ”¹æ’ç­ | UPDATE schedules | æ—¶åºå›¾7 |
| å–æ¶ˆæ’ç­ | UPDATE schedules (status='cancelled')<br>UPDATE appointments (é€€æ¬¾) | æ—¶åºå›¾7 |
| å†²çªæ£€æµ‹ | SELECT schedules (å…¨è¡¨åˆ†æ) | æ—¶åºå›¾8 |

---

## ğŸ” å†²çªç±»å‹é€ŸæŸ¥

| å†²çªç±»å‹ | ä¸¥é‡ç¨‹åº¦ | æ£€æµ‹é€»è¾‘ | è§£å†³æ–¹æ¡ˆ |
|---------|---------|---------|---------|
| åŒ»ç”Ÿé‡å¤æ’ç­ | ğŸ”´ Critical | åŒä¸€åŒ»ç”ŸåŒä¸€æ—¶é—´å¤šæ¬¡æ’ç­ | åˆ é™¤å…¶ä¸­ä¸€ä¸ªæ’ç­ |
| åŠå…¬å®¤å†²çª | ğŸ”´ Critical | åŒä¸€åŠå…¬å®¤åŒä¸€å¤©è¢«å¤šäººä½¿ç”¨ | åˆ†é…ä¸åŒåŠå…¬å®¤ |
| åŒ»ç”Ÿè·¨åŠå…¬å®¤ | ğŸ”´ Critical | åŒä¸€åŒ»ç”ŸåŒä¸€æ—¶æ®µåœ¨å¤šä¸ªåŠå…¬å®¤ | åªä¿ç•™ä¸€ä¸ªåŠå…¬å®¤ |
| å·¥ä½œæ—¶é—´è¿‡é•¿ | ğŸŸ¡ Warning | è¿ç»­å·¥ä½œ > 7å¤© | å®‰æ’ä¼‘æ¯æ—¥ |
| æ—¶é—´æ®µç­æ¬¡ä¸åŒ¹é… | ğŸŸ¡ Warning | ä¸Šåˆæ—¶é—´æ®µåœ¨ä¸‹åˆç­æ¬¡ | ç§»åŠ¨åˆ°æ­£ç¡®ç­æ¬¡ |

---

## ğŸ”¢ å…³é”®SQLæ¨¡æ¿

### 1. åˆ›å»ºæ’ç­
```sql
INSERT INTO schedules 
(doctor_id, schedule_date, slot_id, location_id, 
 total_slots, booked_slots, fee, status)
VALUES (?, ?, ?, ?, ?, 0, ?, 'available');
```

### 2. æŸ¥è¯¢å¯ç”¨æ’ç­ï¼ˆå¤šè¡¨è”åˆï¼‰
```sql
SELECT
    s.schedule_id,
    d.full_name AS doctor_name,
    t.slot_name AS time_period,
    l.name AS location_name,
    s.fee,
    (s.total_slots - s.booked_slots) AS remaining_slots
FROM schedules s
JOIN doctors d ON s.doctor_id = d.doctor_id
JOIN time_slots t ON s.slot_id = t.slot_id
JOIN locations l ON s.location_id = l.location_id
WHERE s.schedule_date = ?
  AND s.status = 'available'
  AND (s.total_slots - s.booked_slots) > 0;
```

### 3. æ£€æŸ¥åŒ»ç”Ÿé‡å¤æ’ç­å†²çª
```sql
SELECT doctor_id, schedule_date, slot_id, COUNT(*) as count
FROM schedules
WHERE status = 'available'
GROUP BY doctor_id, schedule_date, slot_id
HAVING COUNT(*) > 1;
```

### 4. æ£€æŸ¥åŠå…¬å®¤å†²çª
```sql
SELECT location_id, schedule_date, 
       GROUP_CONCAT(DISTINCT doctor_id) as doctors,
       COUNT(DISTINCT doctor_id) as doctor_count
FROM schedules
WHERE status = 'available'
GROUP BY location_id, schedule_date
HAVING COUNT(DISTINCT doctor_id) > 1;
```

### 5. å–æ¶ˆæ’ç­å¹¶å¤„ç†é¢„çº¦
```sql
-- 1. æ›´æ–°æ’ç­çŠ¶æ€
UPDATE schedules 
SET status = 'cancelled', 
    cancellation_reason = ?,
    cancelled_at = NOW()
WHERE schedule_id = ?;

-- 2. æ›´æ–°é¢„çº¦çŠ¶æ€
UPDATE appointments
SET status = 'cancelled_by_admin',
    refund_status = 'pending',
    cancelled_at = NOW()
WHERE schedule_id = ?
  AND status IN ('confirmed', 'paid');
```

### 6. æŸ¥æ‰¾è¯·å‡æœŸé—´çš„å†²çªæ’ç­
```sql
SELECT * FROM schedules
WHERE doctor_id = ?
  AND schedule_date BETWEEN ? AND ?
  AND status = 'available';
```

---

## ğŸ“Š çŠ¶æ€å€¼é€ŸæŸ¥

### schedules.status
| å€¼ | è¯´æ˜ |
|----|------|
| available | å¯é¢„çº¦ |
| full | å·²æ»¡ |
| cancelled | å·²å–æ¶ˆ |

### appointments.status
| å€¼ | è¯´æ˜ |
|----|------|
| pending | å¾…ç¡®è®¤ |
| confirmed | å·²ç¡®è®¤ |
| paid | å·²æ”¯ä»˜ |
| cancelled_by_patient | æ‚£è€…å–æ¶ˆ |
| cancelled_by_doctor | åŒ»ç”Ÿå–æ¶ˆ |
| cancelled_by_admin | ç®¡ç†å‘˜å–æ¶ˆ |
| completed | å·²å®Œæˆ |

### leave_requests.status
| å€¼ | è¯´æ˜ |
|----|------|
| pending | å¾…å®¡æ‰¹ |
| approved | å·²æ‰¹å‡† |
| rejected | å·²æ‹’ç» |
| cancelled | å·²æ’¤é”€ |

---

## ğŸ¨ å‰ç«¯ç»„ä»¶æ˜ å°„

### é¡µé¢ä¸åŠŸèƒ½æ˜ å°„
| é¡µé¢/ç»„ä»¶ | ä¸»è¦åŠŸèƒ½ | æ¶‰åŠAPI |
|----------|---------|---------|
| ScheduleDashboard.vue | æ’ç­ç®¡ç†ä¸»ç•Œé¢ | GET /api/schedules |
| å¾…æ’ç­åŒ»ç”Ÿå¡ç‰‡ | æ‹–æ‹½åˆ›å»ºæ’ç­ | POST /api/schedules/create |
| æ‰¹é‡å¯¼å…¥é¢æ¿ | Excelå¯¼å…¥ | POST /api/schedules/batch-import |
| æ—¶é—´æ®µå¡ç‰‡ | æ‹–æ‹½åˆ†é…æ—¶é—´æ®µ | - |
| åŠå…¬åœ°ç‚¹å¡ç‰‡ | æ‹–æ‹½åˆ†é…åœ°ç‚¹ | - |
| å†²çªæ£€æµ‹æŒ‰é’® | æ‰‹åŠ¨è§¦å‘æ£€æµ‹ | POST /api/schedules/detect-conflicts |

### å†²çªé«˜äº®CSSç±»
| CSSç±» | é¢œè‰² | ç”¨é€” |
|-------|------|------|
| conflict-error | ğŸ”´ çº¢è‰² | ä¸¥é‡å†²çª |
| conflict-warning | ğŸŸ¡ é»„è‰² | è­¦å‘Šå†²çª |
| time-slot-mismatch | ğŸ”´ çº¢è‰² | æ—¶é—´æ®µä¸åŒ¹é… |

---

## ğŸš€ APIç«¯ç‚¹é€ŸæŸ¥

### æ’ç­ç®¡ç†API
```
GET    /api/schedules/list              - è·å–æ’ç­åˆ—è¡¨
GET    /api/schedules/:id/detail        - è·å–æ’ç­è¯¦æƒ…
POST   /api/schedules/create            - åˆ›å»ºå•ä¸ªæ’ç­
POST   /api/schedules/batch-import      - æ‰¹é‡å¯¼å…¥æ’ç­
PUT    /api/schedules/:id/update        - æ›´æ–°æ’ç­
POST   /api/schedules/:id/cancel        - å–æ¶ˆæ’ç­
DELETE /api/schedules/:id               - åˆ é™¤æ’ç­
```

### å†²çªæ£€æµ‹API
```
POST   /api/schedules/detect-conflicts  - æ‰§è¡Œå†²çªæ£€æµ‹
GET    /api/schedules/conflicts         - è·å–å†²çªåˆ—è¡¨
```

### è¯·å‡ç®¡ç†API
```
GET    /api/leave-requests/pending      - è·å–å¾…å®¡æ‰¹è¯·å‡
POST   /api/leave-requests/create       - åˆ›å»ºè¯·å‡ç”³è¯·
POST   /api/leave-requests/approve      - æ‰¹å‡†è¯·å‡
POST   /api/leave-requests/reject       - æ‹’ç»è¯·å‡
```

### åŸºç¡€æ•°æ®API
```
GET    /api/doctors                     - è·å–åŒ»ç”Ÿåˆ—è¡¨
GET    /api/time-slots                  - è·å–æ—¶é—´æ®µåˆ—è¡¨
GET    /api/locations                   - è·å–è¯Šå®¤åˆ—è¡¨
GET    /api/departments                 - è·å–ç§‘å®¤åˆ—è¡¨
```

---

## âš¡ å¸¸è§é—®é¢˜é€ŸæŸ¥

### Q1: å¦‚ä½•é˜²æ­¢åŒ»ç”Ÿé‡å¤æ’ç­ï¼Ÿ
**A**: åœ¨åˆ›å»ºæ’ç­æ—¶ï¼Œåç«¯æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢ï¼š
```sql
SELECT * FROM schedules
WHERE doctor_id = ? 
  AND schedule_date = ?
  AND slot_id = ?
  AND status = 'available';
```
å¦‚æœè¿”å›ç»“æœä¸ä¸ºç©ºï¼Œåˆ™æ‹’ç»åˆ›å»ºã€‚

### Q2: æ‰¹é‡å¯¼å…¥å¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿ
**A**: ç³»ç»Ÿä¼šè¿”å›è¯¦ç»†çš„é”™è¯¯åˆ—è¡¨ï¼ŒåŒ…æ‹¬ï¼š
- ç¬¬å‡ è¡Œ
- é”™è¯¯åŸå› ï¼ˆåŒ»ç”Ÿä¸å­˜åœ¨ã€æ—¶é—´æ®µå†²çªç­‰ï¼‰
- æˆåŠŸå¯¼å…¥çš„æ•°é‡
æŸ¥çœ‹é”™è¯¯è¯¦æƒ…åï¼Œä¿®æ­£Excelæ•°æ®é‡æ–°å¯¼å…¥ã€‚

### Q3: å¦‚ä½•æŸ¥çœ‹æŸä¸ªåŒ»ç”Ÿçš„æ‰€æœ‰æ’ç­ï¼Ÿ
**A**: 
```sql
SELECT s.*, t.slot_name, l.name as location
FROM schedules s
JOIN time_slots t ON s.slot_id = t.slot_id
JOIN locations l ON s.location_id = l.location_id
WHERE s.doctor_id = ?
  AND s.schedule_date BETWEEN ? AND ?
ORDER BY s.schedule_date, t.start_time;
```

### Q4: å–æ¶ˆæ’ç­åæ‚£è€…å¦‚ä½•é€€æ¬¾ï¼Ÿ
**A**: æµç¨‹å¦‚ä¸‹ï¼š
1. æ›´æ–°`appointments`è¡¨ï¼Œè®¾ç½®`status='cancelled'`, `refund_status='pending'`
2. åå°å®šæ—¶ä»»åŠ¡æ‰«æ`refund_status='pending'`çš„è®°å½•
3. è°ƒç”¨æ”¯ä»˜æ¥å£æ‰§è¡Œé€€æ¬¾
4. æ›´æ–°`refund_status='completed'`

### Q5: å†²çªæ£€æµ‹ä»€ä¹ˆæ—¶å€™è§¦å‘ï¼Ÿ
**A**: ä»¥ä¸‹æ“ä½œä¼šè‡ªåŠ¨è§¦å‘ï¼š
- åˆ›å»ºæ’ç­å
- ä¿®æ”¹æ’ç­å
- æ‰¹é‡å¯¼å…¥å
- åŒ»ç”Ÿè¯·å‡è¢«æ‰¹å‡†å
- æ‰‹åŠ¨ç‚¹å‡»"æ£€æµ‹å†²çª"æŒ‰é’®

---

## ğŸ“± å¿«æ·é”®ï¼ˆå‰ç«¯ï¼‰

| å¿«æ·é”® | åŠŸèƒ½ |
|--------|------|
| Ctrl + S | ä¿å­˜å½“å‰ç¼–è¾‘ |
| Ctrl + D | æ£€æµ‹å†²çª |
| Ctrl + I | æ‰“å¼€æ‰¹é‡å¯¼å…¥ |
| Esc | å…³é—­å¯¹è¯æ¡† |

---

## ğŸ”— ç›¸å…³æ–‡æ¡£é“¾æ¥

- [å®Œæ•´README](./README.md) - è¯¦ç»†æ–‡æ¡£è¯´æ˜
- [å†²çªæ£€æµ‹åŠŸèƒ½è¯´æ˜](../å†²çªæ£€æµ‹åŠŸèƒ½è¯´æ˜.md) - å†²çªæ£€æµ‹è¯¦è§£
- [PlantUMLå®˜æ–¹æ–‡æ¡£](https://plantuml.com/) - UMLè¯­æ³•å‚è€ƒ

---

## ğŸ“Š æ•°æ®é‡ä¼°ç®—

### å•ä¸ªåŒ»é™¢å¹´åº¦æ•°æ®é‡ä¼°ç®—
```
å‡è®¾ï¼š
- åŒ»ç”Ÿæ•°é‡ï¼š200äºº
- æ¯äººæ¯å‘¨æ’ç­ï¼š3æ¬¡
- æ¯å¹´å·¥ä½œå‘¨ï¼š50å‘¨

å¹´åº¦æ’ç­è®°å½• = 200 Ã— 3 Ã— 50 = 30,000æ¡
```

### ç´¢å¼•å»ºè®®
å½“`schedules`è¡¨è¶…è¿‡10ä¸‡æ¡è®°å½•æ—¶ï¼Œå»ºè®®ï¼š
1. æ·»åŠ å¤åˆç´¢å¼•ï¼š`(doctor_id, schedule_date, slot_id)`
2. æ·»åŠ çŠ¶æ€ç´¢å¼•ï¼š`(status, schedule_date)`
3. å®šæœŸå½’æ¡£å†å²æ•°æ®ï¼ˆè¶…è¿‡1å¹´ï¼‰

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–æ¸…å•

- [ ] ä¸º`schedules`è¡¨æ·»åŠ ç´¢å¼•
- [ ] ä¸º`appointments`è¡¨æ·»åŠ ç´¢å¼•
- [ ] å¯ç”¨æŸ¥è¯¢ç¼“å­˜ï¼ˆ`time_slots`, `locations`ï¼‰
- [ ] ä½¿ç”¨Redisç¼“å­˜å†²çªæ£€æµ‹ç»“æœï¼ˆ5åˆ†é’Ÿï¼‰
- [ ] æ‰¹é‡å¯¼å…¥ä½¿ç”¨äº‹åŠ¡æ‰¹é‡æ’å…¥
- [ ] å®šæœŸå½’æ¡£å†å²æ’ç­æ•°æ®
- [ ] æ•°æ®åº“è¯»å†™åˆ†ç¦»ï¼ˆå¦‚æœå¹¶å‘é«˜ï¼‰

---

**æœ€åæ›´æ–°**: 2025å¹´10æœˆ20æ—¥  
**é€‚ç”¨ç‰ˆæœ¬**: v1.0+



