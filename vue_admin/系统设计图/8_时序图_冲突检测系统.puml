@startuml å†²çªæ£€æµ‹ç³»ç»Ÿæ—¶åºå›¾

title æ’ç­å†²çªæ£€æµ‹ç³»ç»Ÿ - å®Œæ•´æ—¶åºå›¾

actor ç®¡ç†å‘˜ as Admin
participant "å‰ç«¯ç•Œé¢" as Frontend
participant "åç«¯API" as Backend
participant "å†²çªæ£€æµ‹å¼•æ“" as ConflictEngine
database "schedulesè¡¨" as SchedulesDB

== è§¦å‘å†²çªæ£€æµ‹ ==
Admin -> Frontend : æ“ä½œè§¦å‘æ£€æµ‹\n(åˆ›å»º/ä¿®æ”¹/å¯¼å…¥æ’ç­å)
activate Frontend

alt è‡ªåŠ¨è§¦å‘
    Frontend -> Frontend : å»¶è¿Ÿ500msåè‡ªåŠ¨è§¦å‘
    note right: é˜²æŠ–æœºåˆ¶ï¼Œé¿å…é¢‘ç¹æ£€æµ‹
else æ‰‹åŠ¨è§¦å‘
    Admin -> Frontend : ç‚¹å‡»"æ£€æµ‹å†²çª"æŒ‰é’®
end

Frontend -> Backend : POST /api/schedules/detect-conflicts\n{\n  department_id: 5,\n  date_range: {\n    start: "2025-11-01",\n    end: "2025-11-30"\n  }\n}
activate Backend

Backend -> ConflictEngine : å¯åŠ¨å†²çªæ£€æµ‹
activate ConflictEngine

ConflictEngine -> SchedulesDB : è·å–æ’ç­æ•°æ®\nSELECT * FROM schedules\nWHERE schedule_date BETWEEN '2025-11-01' AND '2025-11-30'\nAND status = 'available'
activate SchedulesDB
SchedulesDB --> ConflictEngine : è¿”å›æ’ç­åˆ—è¡¨
deactivate SchedulesDB

ConflictEngine -> ConflictEngine : åˆå§‹åŒ–å†²çªæ•°æ®ç»“æ„\n{\n  conflicts: [],\n  summary: {\n    total: 0,\n    critical: 0,\n    warning: 0\n  }\n}

== å†²çªç±»å‹1: åŒ»ç”Ÿé‡å¤æ’ç­ ==
ConflictEngine -> ConflictEngine : detectDoctorDoubleBooking()

note right of ConflictEngine
    ç®—æ³•é€»è¾‘ï¼š
    1. åˆ›å»ºMap: doctorScheduleMap
    2. éå†æ‰€æœ‰æ’ç­è®°å½•
    3. ä»¥"doctor_id-date-shift"ä¸ºkey
    4. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒkey
    5. å¦‚å­˜åœ¨ï¼Œæ ‡è®°ä¸ºå†²çª
end note

ConflictEngine -> ConflictEngine : æ„å»ºåŒ»ç”Ÿæ—¶é—´æ˜ å°„\nMap<String, Schedule>\nkey = "doctor_id-date-shift"

loop éå†æ¯æ¡æ’ç­
    ConflictEngine -> ConflictEngine : æ£€æŸ¥keyæ˜¯å¦å·²å­˜åœ¨
    
    alt å‘ç°é‡å¤
        ConflictEngine -> ConflictEngine : æ·»åŠ å†²çªè®°å½•\n{\n  type: 'doctor_double_booking',\n  severity: 'critical',\n  description: "åŒ»ç”ŸXåœ¨Yæ—¶é—´è¢«é‡å¤æ’ç­",\n  doctor_id: 5,\n  date: "2025-11-10",\n  shift: "ä¸Šåˆ"\n}
    end
end

== å†²çªç±»å‹2: åŠå…¬å®¤å†²çª ==
ConflictEngine -> ConflictEngine : detectOfficeConflicts()

note right of ConflictEngine
    ç®—æ³•é€»è¾‘ï¼š
    1. åˆ›å»ºMap: officeDateMap
    2. ä»¥"location-date"ä¸ºkey (ä¸åŒºåˆ†ç­æ¬¡)
    3. è®°å½•ä½¿ç”¨è¯¥åŠå…¬å®¤çš„åŒ»ç”Ÿåˆ—è¡¨
    4. å¦‚æœåŒä¸€åŠå…¬å®¤åŒä¸€å¤©è¢«å¤šäººä½¿ç”¨ï¼Œæ ‡è®°å†²çª
end note

ConflictEngine -> ConflictEngine : æ„å»ºåŠå…¬å®¤æ—¥æœŸæ˜ å°„\nMap<String, List<Doctor>>\nkey = "location-date"

loop éå†æ¯æ¡æ’ç­
    ConflictEngine -> ConflictEngine : æ£€æŸ¥åŒä¸€åŠå…¬å®¤åŒä¸€å¤©
    
    alt å‘ç°å¤šä¸ªåŒ»ç”Ÿä½¿ç”¨
        ConflictEngine -> ConflictEngine : ä¸ºæ‰€æœ‰æ¶‰åŠåŒ»ç”Ÿæ·»åŠ å†²çª\n{\n  type: 'office_conflict',\n  severity: 'critical',\n  description: "åŠå…¬å®¤Xåœ¨Yæ—¥è¢«å¤šäººä½¿ç”¨",\n  location: "é—¨è¯Šæ¥¼-301",\n  date: "2025-11-10",\n  doctor_ids: [5, 6, 7]\n}
    end
end

== å†²çªç±»å‹3: åŒ»ç”Ÿè·¨åŠå…¬å®¤ ==
ConflictEngine -> ConflictEngine : detectDoctorMultiOffice()

note right of ConflictEngine
    ç®—æ³•é€»è¾‘ï¼š
    1. åˆ›å»ºMap: doctorOfficeMap
    2. ä»¥"doctor_id-date-shift"ä¸ºkey
    3. è®°å½•è¯¥åŒ»ç”Ÿè¯¥æ—¶æ®µçš„åŠå…¬å®¤
    4. å¦‚æœåŒä¸€æ—¶æ®µæœ‰å¤šä¸ªä¸åŒåŠå…¬å®¤ï¼Œæ ‡è®°å†²çª
end note

loop éå†æ¯æ¡æ’ç­
    ConflictEngine -> ConflictEngine : æ£€æŸ¥åŒä¸€åŒ»ç”ŸåŒä¸€æ—¶æ®µçš„åŠå…¬å®¤
    
    alt å‘ç°å¤šä¸ªä¸åŒåŠå…¬å®¤
        ConflictEngine -> ConflictEngine : æ·»åŠ å†²çªè®°å½•\n{\n  type: 'doctor_multi_office',\n  severity: 'critical',\n  description: "åŒ»ç”ŸXåœ¨Yæ—¶æ®µè¢«åˆ†é…åˆ°å¤šä¸ªåŠå…¬å®¤",\n  locations: ["301", "305"]\n}
    end
end

== å†²çªç±»å‹4: å·¥ä½œæ—¶é—´è¿‡é•¿ ==
ConflictEngine -> ConflictEngine : detectWorkDurationConflicts()

note right of ConflictEngine
    ç®—æ³•é€»è¾‘ï¼š
    1. æŒ‰åŒ»ç”Ÿåˆ†ç»„æ’ç­è®°å½•
    2. æŒ‰æ—¥æœŸæ’åº
    3. è®¡ç®—è¿ç»­å·¥ä½œå¤©æ•°
    4. å¦‚æœè¶…è¿‡7å¤©ï¼Œæ ‡è®°è­¦å‘Š
end note

ConflictEngine -> ConflictEngine : æŒ‰åŒ»ç”Ÿåˆ†ç»„\nMap<doctor_id, List<Schedule>>

loop éå†æ¯ä¸ªåŒ»ç”Ÿ
    ConflictEngine -> ConflictEngine : æŒ‰æ—¥æœŸæ’åºæ’ç­è®°å½•
    
    ConflictEngine -> ConflictEngine : è®¡ç®—è¿ç»­å·¥ä½œå¤©æ•°
    note right
        consecutiveDays = 1
        for i=1 to schedules.length:
            if (date[i] - date[i-1] == 1å¤©):
                consecutiveDays++
            else:
                consecutiveDays = 1
    end note
    
    alt è¿ç»­å·¥ä½œ > 7å¤©
        ConflictEngine -> ConflictEngine : æ·»åŠ è­¦å‘Š\n{\n  type: 'work_duration_conflict',\n  severity: 'warning',\n  description: "åŒ»ç”ŸXè¿ç»­å·¥ä½œYå¤©",\n  consecutive_days: 9,\n  doctor_id: 5\n}
    end
end

== å†²çªç±»å‹5: æ—¶é—´æ®µç­æ¬¡ä¸åŒ¹é… ==
ConflictEngine -> ConflictEngine : detectTimeSlotMismatch()

note right of ConflictEngine
    æ£€æŸ¥é€»è¾‘ï¼š
    1. æ£€æŸ¥æ—¶é—´æ®µåç§°æ˜¯å¦åŒ…å«"ä¸Šåˆ"æˆ–"ä¸‹åˆ"
    2. æ¯”å¯¹æ—¶é—´æ®µçš„ç­æ¬¡æ ‡è¯†ä¸æ’ç­çš„shiftå­—æ®µ
    3. å¦‚ä¸åŒ¹é…ï¼Œæ ‡è®°è­¦å‘Š
end note

loop éå†æ¯æ¡æ’ç­
    ConflictEngine -> ConflictEngine : æ£€æŸ¥æ—¶é—´æ®µä¸ç­æ¬¡æ˜¯å¦åŒ¹é…
    
    alt æ—¶é—´æ®µåŒ…å«"ä¸Šåˆ"ä½†ç­æ¬¡æ˜¯"ä¸‹åˆ"
        ConflictEngine -> ConflictEngine : æ·»åŠ è­¦å‘Š\n{\n  type: 'time_slot_mismatch',\n  severity: 'warning',\n  description: "æ—¶é—´æ®µä¸ç­æ¬¡ä¸åŒ¹é…"\n}
    else æ—¶é—´æ®µåŒ…å«"ä¸‹åˆ"ä½†ç­æ¬¡æ˜¯"ä¸Šåˆ"
        ConflictEngine -> ConflictEngine : æ·»åŠ è­¦å‘Š
    end
end

== æ±‡æ€»å†²çªç»“æœ ==
ConflictEngine -> ConflictEngine : ç»Ÿè®¡å†²çªæ•°é‡

ConflictEngine -> ConflictEngine : ç”Ÿæˆå†²çªæ‘˜è¦\nsummary = {\n  total: conflicts.length,\n  critical: conflicts.filter(c => c.severity === 'critical').length,\n  warning: conflicts.filter(c => c.severity === 'warning').length\n}

ConflictEngine --> Backend : è¿”å›å®Œæ•´å†²çªæ•°æ®\n{\n  hasConflicts: true,\n  conflicts: [...],\n  summary: {\n    total: 15,\n    critical: 8,\n    warning: 7\n  }\n}
deactivate ConflictEngine

== è¿”å›ç»“æœå¹¶æ›´æ–°ç•Œé¢ ==
Backend -> Backend : ç¼“å­˜å†²çªæ•°æ®

Backend --> Frontend : è¿”å›å†²çªæ£€æµ‹ç»“æœJSON
deactivate Backend

Frontend -> Frontend : æ›´æ–°conflictDataçŠ¶æ€

Frontend -> Frontend : ä¸ºæ¯ä¸ªå†²çªçš„æ’ç­è®°å½•\næ·»åŠ é«˜äº®æ ·å¼ç±»

loop éå†æ’ç­å¡ç‰‡
    Frontend -> Frontend : æ£€æŸ¥è¯¥æ’ç­æ˜¯å¦æœ‰å†²çª
    
    alt æœ‰ä¸¥é‡å†²çª (critical)
        Frontend -> Frontend : åº”ç”¨çº¢è‰²é«˜äº®\nclass="conflict-error"
    else æœ‰è­¦å‘Šå†²çª (warning)
        Frontend -> Frontend : åº”ç”¨é»„è‰²é«˜äº®\nclass="conflict-warning"
    else æ— å†²çª
        Frontend -> Frontend : æ­£å¸¸æ˜¾ç¤º
    end
end

Frontend --> Admin : æ›´æ–°ç•Œé¢æ˜¾ç¤º\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ âš ï¸ å‘ç° 15 ä¸ªå†²çª         â”‚\nâ”‚ ğŸ”´ ä¸¥é‡: 8  ğŸŸ¡ è­¦å‘Š: 7   â”‚\nâ”‚                         â”‚\nâ”‚ [æ’ç­å¡ç‰‡ - çº¢è‰²èƒŒæ™¯]     â”‚\nâ”‚ åŒ»ç”Ÿ: å¼ ä¸‰ (ID:5)        â”‚\nâ”‚ âš ï¸ åŒ»ç”Ÿé‡å¤æ’ç­          â”‚\nâ”‚                         â”‚\nâ”‚ [æ’ç­å¡ç‰‡ - é»„è‰²èƒŒæ™¯]     â”‚\nâ”‚ åŒ»ç”Ÿ: æå›› (ID:6)        â”‚\nâ”‚ âš ï¸ è¿ç»­å·¥ä½œ9å¤©           â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
deactivate Frontend

== æŸ¥çœ‹å†²çªè¯¦æƒ… ==
Admin -> Frontend : ç‚¹å‡»æœ‰å†²çªçš„æ’ç­å¡ç‰‡
activate Frontend

Frontend -> Frontend : è¿‡æ»¤è¯¥æ’ç­ç›¸å…³çš„å†²çª

Frontend --> Admin : å¼¹å‡ºè¯¦æƒ…å¯¹è¯æ¡†\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ åŒ»ç”Ÿ: å¼ ä¸‰ (ID:5)        â”‚\nâ”‚ å†²çªç±»å‹: åŒ»ç”Ÿé‡å¤æ’ç­ã€   â”‚\nâ”‚          åŠå…¬å®¤å†²çª      â”‚\nâ”‚                         â”‚\nâ”‚ è¯¦ç»†ä¿¡æ¯:               â”‚\nâ”‚ â€¢ åŒ»ç”Ÿå¼ ä¸‰åœ¨2025-11-10  â”‚\nâ”‚   ä¸Šåˆè¢«é‡å¤æ’ç­         â”‚\nâ”‚   - åœ°ç‚¹1: é—¨è¯Šæ¥¼-301   â”‚\nâ”‚   - åœ°ç‚¹2: é—¨è¯Šæ¥¼-305   â”‚\nâ”‚                         â”‚\nâ”‚ â€¢ åŠå…¬å®¤é—¨è¯Šæ¥¼-301åœ¨     â”‚\nâ”‚   2025-11-10è¢«å¤šäººä½¿ç”¨  â”‚\nâ”‚   - ä½¿ç”¨åŒ»ç”Ÿ: å¼ ä¸‰ã€æå›› â”‚\nâ”‚                         â”‚\nâ”‚ [å…³é—­]                  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
deactivate Frontend

== è§£å†³å†²çªåé‡æ–°æ£€æµ‹ ==
Admin -> Frontend : ä¿®æ”¹æ’ç­è§£å†³å†²çª
note right: ä¾‹å¦‚ï¼šåˆ é™¤é‡å¤çš„æ’ç­è®°å½•
Frontend -> Backend : æäº¤ä¿®æ”¹
Backend --> Frontend : ä¿®æ”¹æˆåŠŸ
Frontend -> Frontend : è‡ªåŠ¨è§¦å‘å†²çªé‡æ–°æ£€æµ‹
note right: å›åˆ°æµç¨‹å¼€å§‹ï¼Œé‡æ–°æ‰§è¡Œå†²çªæ£€æµ‹

@enduml



