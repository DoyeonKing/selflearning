@startuml
!theme plain
title 自动排班系统类图

' 定义包和分层
package "接口层 (Interface Layer)" {
  ' 自动排班界面接口
  interface IAutoSchedulingDashboard {
    + displayDepartmentSelection()
    + displayUploadInterface()
    + displayScheduleResults()
    + displayManualAdjustmentInterface()
    + showProgressIndicator()
    + showSchedulingSummary()
  }
  
  ' 文件上传接口
  interface IFileUploadHandler {
    + uploadLeaveRequest(file: File)
    + uploadShiftChangeRequest(file: File)
    + validateFileFormat(file: File)
    + parseExcelFile(file: File)
    + parseCSVFile(file: File)
    + downloadTemplate()
  }
  
  ' 排班结果显示接口
  interface IScheduleResultDisplay {
    + displayDoctorCards()
    + displayTimeSlotCards()
    + displayLocationCards()
    + highlightConflicts()
    + showConflictSummary()
    + enableManualAdjustment()
  }
  
  ' 进度显示接口
  interface IProgressIndicator {
    + showProgress(percentage: number)
    + updateProgressMessage(message: string)
    + showCompletionStatus()
    + hideProgress()
  }
}

package "控制层 (Control Layer)" {
  ' 自动排班控制器
  class AutoSchedulingController {
    - schedulingAlgorithm: SchedulingAlgorithm
    - constraintValidator: ConstraintValidator
    - conflictResolver: ConflictResolver
    - departmentId: string
    - schedulingPeriod: DateRange
    --
    + selectDepartment(departmentId: string)
    + uploadConstraints(constraints: Constraint[])
    + generateSchedule(): ScheduleResult
    + validateSchedule(schedule: Schedule): ValidationResult
    + resolveConflicts(conflicts: Conflict[]): ResolutionResult
    + exportSchedule(schedule: Schedule): ExportResult
  }
  
  ' 排班算法控制器
  class SchedulingAlgorithm {
    - constraintEngine: ConstraintEngine
    - optimizationEngine: OptimizationEngine
    - ruleEngine: RuleEngine
    --
    + generateOptimalSchedule(constraints: Constraint[]): Schedule
    + applyConstraints(schedule: Schedule, constraints: Constraint[]): Schedule
    + optimizeSchedule(schedule: Schedule): Schedule
    + validateScheduleRules(schedule: Schedule): ValidationResult
  }
  
  ' 约束验证控制器
  class ConstraintValidator {
    - validationRules: ValidationRule[]
    --
    + validateLeaveConstraints(leaveRequests: LeaveRequest[]): ValidationResult
    + validateShiftConstraints(shiftRequests: ShiftRequest[]): ValidationResult
    + validateWorkloadConstraints(workloads: Workload[]): ValidationResult
    + validateAvailabilityConstraints(availabilities: Availability[]): ValidationResult
  }
  
  ' 冲突解决控制器
  class ConflictResolver {
    - resolutionStrategies: ResolutionStrategy[]
    --
    + detectConflicts(schedule: Schedule): Conflict[]
    + resolveConflicts(conflicts: Conflict[]): ResolutionResult
    + suggestAlternatives(conflict: Conflict): Alternative[]
    + applyResolution(conflict: Conflict, resolution: Resolution): boolean
  }
  
  ' 文件处理控制器
  class FileProcessingController {
    - fileParser: FileParser
    - dataValidator: DataValidator
    - templateGenerator: TemplateGenerator
    --
    + parseUploadedFile(file: File): ParsedData
    + validateParsedData(data: ParsedData): ValidationResult
    + generateTemplate(templateType: string): File
    + exportSchedule(schedule: Schedule, format: string): File
  }
  
  ' 进度管理控制器
  class ProgressController {
    - progressTracker: ProgressTracker
    - statusNotifier: StatusNotifier
    --
    + startProgress(totalSteps: number)
    + updateProgress(currentStep: number, message: string)
    + completeProgress()
    + handleError(error: Error)
  }
}

package "实体层 (Entity Layer)" {
  ' 排班结果实体
  class ScheduleResult {
    - schedule: Schedule
    - conflicts: Conflict[]
    - statistics: SchedulingStatistics
    - qualityScore: number
    - generationTime: number
    --
    + getSchedule(): Schedule
    + getConflicts(): Conflict[]
    + getStatistics(): SchedulingStatistics
    + getQualityScore(): number
    + getGenerationTime(): number
    + hasConflicts(): boolean
    + isValid(): boolean
  }
  
  ' 约束实体
  class Constraint {
    - id: string
    - type: string
    - priority: number
    - parameters: Map<string, any>
    - isActive: boolean
    --
    + getId(): string
    + getType(): string
    + getPriority(): number
    + getParameters(): Map<string, any>
    + isActive(): boolean
    + setActive(active: boolean)
  }
  
  ' 请假请求实体
  class LeaveRequest {
    - doctorId: string
    - startDate: Date
    - endDate: Date
    - reason: string
    - status: string
    - approvedBy: string
    --
    + getDoctorId(): string
    + getStartDate(): Date
    + getEndDate(): Date
    + getReason(): string
    + getStatus(): string
    + getApprovedBy(): string
    + approve(approvedBy: string)
    + reject(reason: string)
  }
  
  ' 调班请求实体
  class ShiftRequest {
    - doctorId: string
    - originalDate: Date
    - originalShift: string
    - newDate: Date
    - newShift: string
    - reason: string
    - status: string
    --
    + getDoctorId(): string
    + getOriginalDate(): Date
    + getOriginalShift(): string
    + getNewDate(): Date
    + getNewShift(): string
    + getReason(): string
    + getStatus(): string
    + approve()
    + reject(reason: string)
  }
  
  ' 工作量约束实体
  class Workload {
    - doctorId: string
    - maxHoursPerWeek: number
    - maxConsecutiveDays: number
    - preferredShifts: string[]
    - unavailableDates: Date[]
    --
    + getDoctorId(): string
    + getMaxHoursPerWeek(): number
    + getMaxConsecutiveDays(): number
    + getPreferredShifts(): string[]
    + getUnavailableDates(): Date[]
    + setMaxHoursPerWeek(hours: number)
    + addUnavailableDate(date: Date)
  }
  
  ' 可用性约束实体
  class Availability {
    - doctorId: string
    - availableDates: Date[]
    - availableShifts: string[]
    - preferredLocations: string[]
    --
    + getDoctorId(): string
    + getAvailableDates(): Date[]
    + getAvailableShifts(): string[]
    + getPreferredLocations(): string[]
    + addAvailableDate(date: Date)
    + addAvailableShift(shift: string)
  }
  
  ' 排班统计实体
  class SchedulingStatistics {
    - totalDoctors: number
    - totalShifts: number
    - conflictCount: number
    - averageWorkload: number
    - satisfactionScore: number
    --
    + getTotalDoctors(): number
    + getTotalShifts(): number
    + getConflictCount(): number
    + getAverageWorkload(): number
    + getSatisfactionScore(): number
    + calculateQualityScore(): number
  }
  
  ' 解析数据实体
  class ParsedData {
    - leaveRequests: LeaveRequest[]
    - shiftRequests: ShiftRequest[]
    - workloadConstraints: Workload[]
    - availabilityConstraints: Availability[]
    - validationErrors: ValidationError[]
    --
    + getLeaveRequests(): LeaveRequest[]
    + getShiftRequests(): ShiftRequest[]
    + getWorkloadConstraints(): Workload[]
    + getAvailabilityConstraints(): Availability[]
    + getValidationErrors(): ValidationError[]
    + hasErrors(): boolean
  }
  
  ' 验证结果实体
  class ValidationResult {
    - isValid: boolean
    - errors: ValidationError[]
    - warnings: ValidationWarning[]
    - suggestions: ValidationSuggestion[]
    --
    + isValid(): boolean
    + getErrors(): ValidationError[]
    + getWarnings(): ValidationWarning[]
    + getSuggestions(): ValidationSuggestion[]
    + addError(error: ValidationError)
    + addWarning(warning: ValidationWarning)
  }
  
  ' 验证错误实体
  class ValidationError {
    - code: string
    - message: string
    - severity: string
    - field: string
    - lineNumber: number
    --
    + getCode(): string
    + getMessage(): string
    + getSeverity(): string
    + getField(): string
    + getLineNumber(): number
  }
  
  ' 验证警告实体
  class ValidationWarning {
    - code: string
    - message: string
    - field: string
    - lineNumber: number
    --
    + getCode(): string
    + getMessage(): string
    + getField(): string
    + getLineNumber(): number
  }
  
  ' 验证建议实体
  class ValidationSuggestion {
    - code: string
    - message: string
    - field: string
    - suggestedValue: any
    --
    + getCode(): string
    + getMessage(): string
    + getField(): string
    + getSuggestedValue(): any
  }
  
  ' 解析结果实体
  class ResolutionResult {
    - isResolved: boolean
    - appliedResolutions: Resolution[]
    - remainingConflicts: Conflict[]
    - qualityImpact: number
    --
    + isResolved(): boolean
    + getAppliedResolutions(): Resolution[]
    + getRemainingConflicts(): Conflict[]
    + getQualityImpact(): number
    + addAppliedResolution(resolution: Resolution)
  }
  
  ' 解决方案实体
  class Resolution {
    - conflictId: string
    - strategy: string
    - parameters: Map<string, any>
    - qualityImpact: number
    - isApplied: boolean
    --
    + getConflictId(): string
    + getStrategy(): string
    + getParameters(): Map<string, any>
    + getQualityImpact(): number
    + isApplied(): boolean
    + apply(): boolean
  }
  
  ' 替代方案实体
  class Alternative {
    - id: string
    - description: string
    - qualityScore: number
    - feasibilityScore: number
    - parameters: Map<string, any>
    --
    + getId(): string
    + getDescription(): string
    + getQualityScore(): number
    + getFeasibilityScore(): number
    + getParameters(): Map<string, any>
    + calculateOverallScore(): number
  }
  
  ' 进度跟踪实体
  class ProgressTracker {
    - totalSteps: number
    - currentStep: number
    - currentMessage: string
    - startTime: Date
    - endTime: Date
    - isCompleted: boolean
    --
    + getTotalSteps(): number
    + getCurrentStep(): number
    + getCurrentMessage(): string
    + getStartTime(): Date
    + getEndTime(): Date
    + isCompleted(): boolean
    + updateProgress(step: number, message: string)
    + complete()
  }
}

' 关系定义
' 控制层与实体层的关系
AutoSchedulingController --> ScheduleResult : creates
AutoSchedulingController --> Constraint : manages
AutoSchedulingController --> LeaveRequest : processes
AutoSchedulingController --> ShiftRequest : processes
AutoSchedulingController --> Workload : manages
AutoSchedulingController --> Availability : manages

SchedulingAlgorithm --> Schedule : generates
SchedulingAlgorithm --> Constraint : applies

ConstraintValidator --> ValidationResult : creates
ConstraintValidator --> ValidationError : creates
ConstraintValidator --> ValidationWarning : creates
ConstraintValidator --> ValidationSuggestion : creates

ConflictResolver --> ResolutionResult : creates
ConflictResolver --> Resolution : creates
ConflictResolver --> Alternative : suggests

FileProcessingController --> ParsedData : creates
FileProcessingController --> ValidationResult : creates

ProgressController --> ProgressTracker : manages

' 接口层与控制层的关系
IAutoSchedulingDashboard ..> AutoSchedulingController : uses
IFileUploadHandler ..> FileProcessingController : uses
IScheduleResultDisplay ..> AutoSchedulingController : uses
IProgressIndicator ..> ProgressController : uses

' 实体层内部关系
ScheduleResult --> Schedule : contains 1
ScheduleResult --> Conflict : contains 0..*
ScheduleResult --> SchedulingStatistics : contains 1

ParsedData --> LeaveRequest : contains 0..*
ParsedData --> ShiftRequest : contains 0..*
ParsedData --> Workload : contains 0..*
ParsedData --> Availability : contains 0..*
ParsedData --> ValidationError : contains 0..*

ValidationResult --> ValidationError : contains 0..*
ValidationResult --> ValidationWarning : contains 0..*
ValidationResult --> ValidationSuggestion : contains 0..*

ResolutionResult --> Resolution : contains 0..*
ResolutionResult --> Conflict : contains 0..*

' 泛化关系
Constraint <|-- LeaveRequest
Constraint <|-- ShiftRequest
Constraint <|-- Workload
Constraint <|-- Availability

ValidationError <|-- DataFormatError
ValidationError <|-- BusinessRuleError
ValidationError <|-- ConstraintViolationError

Resolution <|-- DoctorReassignmentResolution
Resolution <|-- ShiftAdjustmentResolution
Resolution <|-- LocationChangeResolution

' 组合关系
AutoSchedulingController *-- SchedulingAlgorithm
AutoSchedulingController *-- ConstraintValidator
AutoSchedulingController *-- ConflictResolver
AutoSchedulingController *-- FileProcessingController
AutoSchedulingController *-- ProgressController

@enduml




